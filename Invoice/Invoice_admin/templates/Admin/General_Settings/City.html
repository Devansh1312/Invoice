{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}
{% load sass_tags %}

{% block css %}
<!-- Plugins css start-->
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/datatables.scss' %}">
<!-- Plugins css Ends-->
{% endblock %}
<style>
   .is-invalid {
   border-color: #dc3545;
   background-color: #f8d7da;
}
</style>

{% block title %}
City Management
{% endblock %}

{% block content %}
<div class="page-body">
	<div class="container-fluid">
		<div class="page-title">
			<div class="row">
				<div class="col-12 col-md-6">
					<h3>{{breadcrumb.child}}</h3>
				</div>
				<div class="col-12 col-md-6">
					<ol class="breadcrumb">
						<button class="btn btn-pill btn-outline-primary-2x ml-auto" data-bs-toggle="modal" data-bs-target="#addCityModal">Add City</button>
					</ol>
				</div>
			</div>
		</div>
		<div class="row">
			<!-- City List -->
			<div class="col-sm-12">
				<div class="card">
					<div class="card-body">
						<div class="table-responsive">
							<table class="display" id="basic-1">
								<thead>
									<tr>
										<th>ID</th>
										<th>Name (English)</th>
										<th>Name (Arabic)</th>
										<th>Country</th>
										<th>Status</th>
										<th>Actions</th>
									</tr>
								</thead>
								<tbody> {% for city_item in cities %} <tr>
										<td>{{ forloop.counter }}</td>
										<td>{{ city_item.name_en }}</td>
										<td>{{ city_item.name_ar }}</td>
										<td>{{ city_item.country.name_en }}</td>
										<td>
											<span class="status-badge" style="color: {% if city_item.status %}green{% else %}red{% endif %};"> 
                                    {% if city_item.status %}Active{% else %}Inactive{% endif %} 
                                 </span>
										</td>
										<td>
											<!-- Action buttons -->
											<div class="action-menu-container" style="position: relative; display: inline-block;">
												<a href="#" class="three-dots-menu" onclick="toggleMenu(this)">
													<i data-feather="more-vertical"></i>
												</a>
												<div class="action-card" style="display: none; position: absolute; top: 100%; right: 0; background: #fff; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1); z-index: 10; width: auto;">
													<ul style="list-style: none; padding: 0; margin: 0;">
														<li style="padding: 8px 12px;">
															<a style="font-size: small;" href="#" data-bs-toggle="modal" data-bs-target="#editCityModal" data-city-id="{{ city_item.id }}" data-city-name_en="{{ city_item.name_en }}" data-city-name_ar="{{ city_item.name_ar }}" data-city-country="{{ city_item.country.id }}" data-city-status="{{ city_item.status }}"> Edit </a>
														</li>
													</ul>
												</div>
											</div>
										</td>
									</tr> 
                           {% endfor %} 
                        </tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<!-- Add City Modal -->
<div class="modal fade" id="addCityModal" tabindex="-1" aria-labelledby="addCityModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="addCityModalLabel">Add City</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<form method="post" action="{% url 'city_create' %}" id="addCityForm"> 
               {% csrf_token %} 
               <div class="row">
						<div class="col-12 col-sm-6 mb-3">
							<label for="name_en" class="form-label">Name (English)</label>
							<input type="text" class="form-control" id="name_en" name="name_en" placeholder="Enter City Name">
							<div class="invalid-feedback" id="name_en-error"></div>
						</div>
						<div class="col-12 col-sm-6 mb-3">
							<label for="name_ar" class="form-label">Name (Arabic)</label>
							<input type="text" class="form-control" id="name_ar" name="name_ar" placeholder="Enter City Name">
							<div class="invalid-feedback" id="name_ar-error"></div>
						</div>
						<div class="col-12 col-sm-6 mb-3">
							<label for="country" class="form-label">Country</label>
							<select class="form-control" id="country" name="country">
								<option value="">
                           Select Country
                        </option>
                        {% for country in countries %}
                           <option value="{{ country.id }}">
                              {{ country.name_en }}
                           </option> 
                        {% endfor %}
							</select>
							<div class="invalid-feedback" id="country-error"></div>
						</div>
						<div class="col-12 col-sm-6 mb-3">
							<label for="status" class="form-label">Status</label>
							<select class="form-control" id="status" name="status">
								<option value="1">Active</option>
								<option value="0">Inactive</option>
							</select>
						</div>
						<button type="submit" class="btn btn-primary">Add City</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>
<!-- Edit City Modal -->
<div class="modal fade" id="editCityModal" tabindex="-1" aria-labelledby="editCityModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="editCityModalLabel">Edit City</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<form method="post" id="editCityForm"> 
               {% csrf_token %} 
               <div class="row">
						<input type="hidden" id="editCityId" name="id">
						<div class="col-12 col-sm-6 mb-3">
							<label for="editName_en" class="form-label">Name (English)</label>
							<input type="text" class="form-control" id="editName_en" name="name_en" placeholder="Enter City Name">
							<div class="invalid-feedback" id="edit-name_en-error"></div>
						</div>
						<div class="col-12 col-sm-6 mb-3">
							<label for="editName_ar" class="form-label">Name (Arabic)</label>
							<input type="text" class="form-control" id="editName_ar" name="name_ar" placeholder="Enter City Name">
							<div class="invalid-feedback" id="edit-name_ar-error"></div>
						</div>
						<div class="col-12 col-sm-6 mb-3">
							<label for="editCountry" class="form-label">Country</label>
							<select class="form-control" id="editCountry" name="country">
                        {% for country in countries %} 
                        <option value="{{ country.id }}">
                           {{ country.name_en }}
                        </option> 
                        {% endfor %} 
                     </select>
							<div class="invalid-feedback" id="edit-country-error"></div>
						</div>
						<div class="col-12 col-sm-6 mb-3">
							<label for="editStatus" class="form-label">Status</label>
							<select class="form-control" id="editStatus" name="status">
								<option value="1">Active</option>
								<option value="0">Inactive</option>
							</select>
						</div>
						<button type="submit" class="btn btn-primary">Update City</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

{% endblock %}

{% block script %}
<script src="{% static 'assets/js/datatable/datatables/jquery.dataTables.min.js'%}"></script>
<script src="{% static 'assets/js/datatable/datatables/datatable.custom.js'%}"></script>
<script src="{% static 'assets/js/tooltip-init.js'%}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Edit City Modal
        var editCityModal = document.getElementById('editCityModal');
        if (editCityModal) {
            editCityModal.addEventListener('show.bs.modal', function(event) {
                var button = event.relatedTarget;
                var cityId = button.getAttribute('data-city-id');
                var cityNameEn = button.getAttribute('data-city-name_en');
                var cityNameAr = button.getAttribute('data-city-name_ar');
                var cityCountry = button.getAttribute('data-city-country');
                var cityStatus = button.getAttribute('data-city-status');
    
                var form = document.getElementById('editCityForm');
                form.action = "{% url 'city_edit' 0 %}".replace('0', cityId);
    
                form.querySelector('#editCityId').value = cityId;
                form.querySelector('#editName_en').value = cityNameEn;
                form.querySelector('#editName_ar').value = cityNameAr;
                form.querySelector('#editCountry').value = cityCountry;
                form.querySelector('#editStatus').value = cityStatus === 'True' ? '1' : '0';
            });
        }
        
        // Toggle the visibility of the action card
        document.querySelectorAll('.three-dots-menu').forEach(function(menu) {
            menu.addEventListener('click', function(event) {
                event.preventDefault();
                var actionCard = menu.nextElementSibling;
                actionCard.style.display = (actionCard.style.display === 'none' || actionCard.style.display === '') ? 'block' : 'none';
                // Close other open action cards
                document.querySelectorAll('.action-card').forEach(function(card) {
                    if (card !== actionCard) {
                        card.style.display = 'none';
                    }
                });
            });
        });
    
        // Hide action card if clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.action-menu-container')) {
                document.querySelectorAll('.action-card').forEach(function(card) {
                    card.style.display = 'none';
                });
            }
        });
    
        // Enhanced form validation for all required fields
        function validateForm(form) {
            let isValid = true;
            const requiredFields = ['name_en', 'name_ar', 'country', 'status'];
            
            // Clear all previous errors
            form.querySelectorAll('.is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
            form.querySelectorAll('.invalid-feedback').forEach(el => {
                el.textContent = '';
            });
    
            // Validate each required field
            requiredFields.forEach(field => {
                const input = form.querySelector(`[name="${field}"]`);
                const errorElement = document.getElementById(`${field}-error`) || 
                                    document.getElementById(`edit-${field}-error`);
                
                if (!input.value.trim()) {
                    input.classList.add('is-invalid');
                    if (errorElement) errorElement.textContent = 'This field is required.';
                    isValid = false;
                }
            });
    
            return isValid;
        }
    
        // Add form submission with validation
        document.getElementById('addCityForm').addEventListener('submit', function(e) {
            if (!validateForm(this)) {
                e.preventDefault();
                // Scroll to first invalid field
                const firstInvalid = this.querySelector('.is-invalid');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        });
    
        // Edit form submission with validation
        document.getElementById('editCityForm').addEventListener('submit', function(e) {
            if (!validateForm(this)) {
                e.preventDefault();
                // Scroll to first invalid field
                const firstInvalid = this.querySelector('.is-invalid');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        });
    
        // Real-time validation on input
        function setupFieldValidation(form) {
            const fields = form.querySelectorAll('input, select');
            fields.forEach(field => {
                field.addEventListener('input', function() {
                    const errorId = this.name + '-error' || 'edit-' + this.name + '-error';
                    const errorElement = document.getElementById(errorId);
                    
                    if (this.value.trim()) {
                        this.classList.remove('is-invalid');
                        if (errorElement) errorElement.textContent = '';
                    }
                });
            });
        }
    
        // Setup validation for both forms
        setupFieldValidation(document.getElementById('addCityForm'));
        setupFieldValidation(document.getElementById('editCityForm'));
    
        // Additional validation for select elements on change
        document.querySelectorAll('select').forEach(select => {
            select.addEventListener('change', function() {
                const errorId = this.name + '-error' || 'edit-' + this.name + '-error';
                const errorElement = document.getElementById(errorId);
                
                if (this.value) {
                    this.classList.remove('is-invalid');
                    if (errorElement) errorElement.textContent = '';
                }
            });
        });
    });
    </script>
{% endblock %}