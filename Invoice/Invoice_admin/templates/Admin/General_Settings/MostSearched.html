{% extends 'base.html' %} 
{% load custom_filters %} 
{% load static %} 
{% load sass_tags %} 

{% block css %}
<!-- Plugins css start-->
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/datatables.scss' %}">
<!-- Plugins css Ends--> 
{% endblock %} 

<style>
    .is-invalid {
        border-color: #dc3545;
        background-color: #f8d7da;
    }
</style> 

{% block title %}Most Searched Management{% endblock %} 

{% block content %} 
<div class="page-body">
    <div class="container-fluid">
        <div class="page-title">
            <div class="row">
                <div class="col-6">
                    <h3>{{breadcrumb.child}}</h3>
                </div>
                <div class="col-6">
                    <ol class="breadcrumb">
                        <button class="btn btn-pill btn-outline-primary-2x ml-auto" data-bs-toggle="modal" data-bs-target="#addMostSearchedModal">Add Most Searched</button>
                    </ol>
                </div>
            </div>
        </div>
        <div class="row">
            <!-- Most Searched List -->
            <div class="col-sm-12">
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="display" id="basic-1">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Question (English)</th>
                                        <th>Question (Arabic)</th>
                                        <th>Answer (English)</th>
                                        <th>Answer (Arabic)</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody> 
                                    {% for item in most_searched %} 
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ item.question_en|truncatechars:50 }}</td>
                                        <td>{{ item.question_ar|truncatechars:50 }}</td>
                                        <td>{{ item.answer_en|truncatechars:50 }}</td>
                                        <td>{{ item.answer_ar|truncatechars:50 }}</td>
                                        <td>
                                            <div class="action-menu-container" style="position: relative; display: inline-block;">
                                                <a href="#" class="three-dots-menu" onclick="toggleMenu(this)">
                                                    <i data-feather="more-vertical"></i>
                                                </a>
                                                <div class="action-card" style="
                                                    display: none;
                                                    position: absolute;
                                                    top: 100%;
                                                    right: 0;
                                                    background: #fff;
                                                    border: 1px solid #ccc;
                                                    border-radius: 4px;
                                                    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
                                                    z-index: 10;
                                                    width: auto;
                                                ">
                                                    <ul style="list-style: none; padding: 0; margin: 0;">
                                                        <li style="padding: 8px 12px;">
                                                            <a style="font-size: small" href="#" data-bs-toggle="modal" data-bs-target="#viewMostSearchedModal" 
                                                            data-item-id="{{ item.id }}" 
                                                            data-item-question_en="{{ item.question_en }}" 
                                                            data-item-question_ar="{{ item.question_ar }}"
                                                            data-item-answer_en="{{ item.answer_en }}"
                                                            data-item-answer_ar="{{ item.answer_ar }}"
                                                            class="view-item-btn"> View </a>
                                                        </li>
                                                        <li style="padding: 8px 12px; border-top: 1px solid #eee;">
                                                            <a style="font-size: small" href="#" data-bs-toggle="modal" data-bs-target="#editMostSearchedModal" 
                                                            data-item-id="{{ item.id }}" 
                                                            data-item-question_en="{{ item.question_en }}" 
                                                            data-item-question_ar="{{ item.question_ar }}"
                                                            data-item-answer_en="{{ item.answer_en }}"
                                                            data-item-answer_ar="{{ item.answer_ar }}"> Edit </a>
                                                        </li>
                                                        <li style="padding: 8px 12px; border-top: 1px solid #eee;">
                                                            <a style="font-size: small;" href="#" data-bs-toggle="modal" data-bs-target="#deleteMostSearchedModal" data-item-id="{{ item.id }}">
                                                            Delete </a>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </td>
                                    </tr> 
                                    {% endfor %} 
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Add Most Searched Modal -->
        <div class="modal fade" id="addMostSearchedModal" tabindex="-1" aria-labelledby="addMostSearchedModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addMostSearchedModalLabel">Add Most Searched</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form method="post" action="{% url 'most_searched_create' %}" id="addMostSearchedForm" enctype="multipart/form-data"> 
                            {% csrf_token %} 
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label for="question_en" class="form-label">Question (English)</label>
                                    <textarea class="form-control" id="question_en" name="question_en" rows="3" placeholder="Enter question in English"></textarea>
                                    <div class="invalid-feedback" id="question_en-error"></div>
                                </div>
                                <div class="col-12 mb-3">
                                    <label for="question_ar" class="form-label">Question (Arabic)</label>
                                    <textarea class="form-control" id="question_ar" name="question_ar" rows="3" placeholder="Enter question in Arabic"></textarea>
                                    <div class="invalid-feedback" id="question_ar-error"></div>
                                </div>
                                <div class="col-12 mb-3">
                                    <label for="answer_en" class="form-label">Answer (English)</label>
                                    <textarea class="form-control" id="answer_en" name="answer_en" rows="5" placeholder="Enter answer in English"></textarea>
                                    <div class="invalid-feedback" id="answer_en-error"></div>
                                </div>
                                <div class="col-12 mb-3">
                                    <label for="answer_ar" class="form-label">Answer (Arabic)</label>
                                    <textarea class="form-control" id="answer_ar" name="answer_ar" rows="5" placeholder="Enter answer in Arabic"></textarea>
                                    <div class="invalid-feedback" id="answer_ar-error"></div>
                                </div>
                                <button type="submit" class="btn btn-primary">Add Most Searched</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- Edit Most Searched Modal -->
        <div class="modal fade" id="editMostSearchedModal" tabindex="-1" aria-labelledby="editMostSearchedModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editMostSearchedModalLabel">Edit Most Searched</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form method="post" id="editMostSearchedForm" enctype="multipart/form-data"> 
                            {% csrf_token %} 
                            <div class="row">
                                <input type="hidden" id="itemId" name="id" />
                                <div class="col-12 mb-3">
                                    <label for="question_en" class="form-label">Question (English)</label>
                                    <textarea class="form-control" id="question_en" name="question_en" rows="3" placeholder="Enter question in English"></textarea>
                                    <div class="invalid-feedback" id="question_en-error"></div>
                                </div>
                                <div class="col-12 mb-3">
                                    <label for="question_ar" class="form-label">Question (Arabic)</label>
                                    <textarea class="form-control" id="question_ar" name="question_ar" rows="3" placeholder="Enter question in Arabic"></textarea>
                                    <div class="invalid-feedback" id="question_ar-error"></div>
                                </div>
                                <div class="col-12 mb-3">
                                    <label for="answer_en" class="form-label">Answer (English)</label>
                                    <textarea class="form-control" id="answer_en" name="answer_en" rows="5" placeholder="Enter answer in English"></textarea>
                                    <div class="invalid-feedback" id="answer_en-error"></div>
                                </div>
                                <div class="col-12 mb-3">
                                    <label for="answer_ar" class="form-label">Answer (Arabic)</label>
                                    <textarea class="form-control" id="answer_ar" name="answer_ar" rows="5" placeholder="Enter answer in Arabic"></textarea>
                                    <div class="invalid-feedback" id="answer_ar-error"></div>
                                </div>
                                <button type="submit" class="btn btn-primary">Update Most Searched</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div> 
</div>
<!-- Delete Most Searched Modal -->
<div class="modal fade" id="deleteMostSearchedModal" tabindex="-1" aria-labelledby="deleteMostSearchedModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteMostSearchedModalLabel">Delete Most Searched</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form method="post" action="" id="deleteMostSearchedForm">
            {% csrf_token %}
            <input type="hidden" id="item_id" name="id">
            <p>Are you sure you want to delete this Most Searched item?</p>
            <button type="submit" class="btn btn-danger">Delete</button>
          </form>
        </div>
      </div>
    </div>
</div>
<!-- View Most Searched Modal -->
<div class="modal fade" id="viewMostSearchedModal" tabindex="-1" aria-labelledby="viewMostSearchedModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewMostSearchedModalLabel">View Most Searched</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-12 mb-3">
                        <h6 class="form-label">Question (English)</h6>
                        <div class="p-3 border rounded" id="view-question-en"></div>
                    </div>
                    <div class="col-12 mb-3">
                        <h6 class="form-label">Question (Arabic)</h6>
                        <div class="p-3 border rounded" id="view-question-ar"></div>
                    </div>
                    <div class="col-12 mb-3">
                        <h6 class="form-label">Answer (English)</h6>
                        <div class="p-3 border rounded" id="view-answer-en"></div>
                    </div>
                    <div class="col-12 mb-3">
                        <h6 class="form-label">Answer (Arabic)</h6>
                        <div class="p-3 border rounded" id="view-answer-ar"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
  
{% endblock %} 

{% block script %} 
<script src="{% static 'assets/js/datatable/datatables/jquery.dataTables.min.js'%}"></script>
<script src="{% static 'assets/js/datatable/datatables/datatable.custom.js'%}"></script>
<script src="{% static 'assets/js/tooltip-init.js'%}"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Edit Most Searched Modal
        var editMostSearchedModal = document.getElementById("editMostSearchedModal");
        if (editMostSearchedModal) {
            editMostSearchedModal.addEventListener("show.bs.modal", function(event) {
                var button = event.relatedTarget;
                var itemId = button.getAttribute("data-item-id");
                var question_en = button.getAttribute("data-item-question_en");
                var question_ar = button.getAttribute("data-item-question_ar");
                var answer_en = button.getAttribute("data-item-answer_en");
                var answer_ar = button.getAttribute("data-item-answer_ar");

                var form = document.getElementById("editMostSearchedForm");
                form.action = "{% url 'most_searched_edit' 0 %}".replace("0", itemId);
                form.querySelector("#itemId").value = itemId;
                form.querySelector("#question_en").value = question_en || "";
                form.querySelector("#question_ar").value = question_ar || "";
                form.querySelector("#answer_en").value = answer_en || "";
                form.querySelector("#answer_ar").value = answer_ar || "";
            });
        }

        // Toggle the visibility of the action card
        document.querySelectorAll(".three-dots-menu").forEach(function(menu) {
            menu.addEventListener("click", function(event) {
                event.preventDefault();
                var actionCard = menu.nextElementSibling;
                actionCard.style.display = actionCard.style.display === "none" || actionCard.style.display === "" ? "block" : "none";
                // Close other open action cards
                document.querySelectorAll(".action-card").forEach(function(card) {
                    if (card !== actionCard) {
                        card.style.display = "none";
                    }
                });
            });
        });

        // Delete Most Searched Modal
        var deleteMostSearchedModal = document.getElementById('deleteMostSearchedModal');
        if (deleteMostSearchedModal) {
            deleteMostSearchedModal.addEventListener('show.bs.modal', function(event) {
                var button = event.relatedTarget;
                var itemID = button.getAttribute('data-item-id');
                var deleteForm = document.getElementById('deleteMostSearchedForm');
                deleteForm.action = "{% url 'most_searched_delete' 0 %}".replace('0', itemID);
            });
        }
    });

    $(document).ready(function () {
        function validateForm(form) {
            let isValid = true;

            // Check each input field in the form
            $(form).find('textarea, input[type="text"]').each(function () {
                const $input = $(this);
                const errorId = $input.attr('id') + '-error';
                const $errorElement = $('#' + errorId);

                if ($input.val().trim() === '') {
                    $input.addClass('is-invalid');
                    $errorElement.text('This field is required.').css('color', 'red');
                    isValid = false;
                } else {
                    $input.removeClass('is-invalid');
                    $errorElement.text('');
                }
            });

            return isValid;
        }

        // Add form validation on submit
        $('#addMostSearchedForm').on('submit', function (event) {
            event.preventDefault();
            if (!validateForm(this)) {
                console.log('Add Most Searched form validation failed');
                return;
            }
            this.submit();
        });

        // Edit form validation on submit
        $('#editMostSearchedForm').on('submit', function (event) {
            event.preventDefault();
            if (!validateForm(this)) {
                console.log('Edit Most Searched form validation failed');
                return;
            }
            this.submit();
        });

        // Reset invalid class and error message on input change
        $('#addMostSearchedForm, #editMostSearchedForm').find('textarea, input[type="text"]').on('input', function () {
            $(this).removeClass('is-invalid');
            $('#' + $(this).attr('id') + '-error').text('');
        });
    });

    // Hide action card if clicking outside
    document.addEventListener("click", function(event) {
        var isClickInside = event.target.closest(".action-menu-container");
        if (!isClickInside) {
            document.querySelectorAll(".action-card").forEach(function(card) {
                card.style.display = "none";
            });
        }
    });

    // View Most Searched Modal
    var viewMostSearchedModal = document.getElementById("viewMostSearchedModal");
    if (viewMostSearchedModal) {
        viewMostSearchedModal.addEventListener("show.bs.modal", function(event) {
            var button = event.relatedTarget;
            var question_en = button.getAttribute("data-item-question_en");
            var question_ar = button.getAttribute("data-item-question_ar");
            var answer_en = button.getAttribute("data-item-answer_en");
            var answer_ar = button.getAttribute("data-item-answer_ar");

            document.getElementById("view-question-en").textContent = question_en || "";
            document.getElementById("view-question-ar").textContent = question_ar || "";
            document.getElementById("view-answer-en").textContent = answer_en || "";
            document.getElementById("view-answer-ar").textContent = answer_ar || "";
        });
    }
</script> 
{% endblock %}