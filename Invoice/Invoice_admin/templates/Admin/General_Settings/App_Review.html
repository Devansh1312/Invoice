{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}
{% load sass_tags %}

{% block css %}
<!-- Plugins css start-->
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/datatables.scss' %}">
<!-- Plugins css Ends-->
<style>
    .review-detail-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .review-detail-title {
        font-weight: 600;
        color: #495057;
        margin-bottom: 15px;
    }
    .review-stars {
        font-size: 1.5rem;
        margin-bottom: 10px;
    }
    .review-content {
        background: #fff;
        padding: 15px;
        border-radius: 5px;
        border-left: 4px solid #3a7afe;
    }
    .feature-badge {
        display: inline-block;
        padding: 5px 10px;
        background-color: #e9ecef;
        border-radius: 20px;
        font-size: 0.9rem;
        margin-right: 5px;
        margin-bottom: 5px;
    }
    .user-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: #3a7afe;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
        margin-right: 15px;
    }
    .user-info {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }
    .features-container {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }
</style>
{% endblock %}

{% block title %}App Reviews{% endblock %}

{% block content %}
<div class="page-body">
    <div class="container-fluid">
        <div class="page-title">
            <div class="row">
                <div class="col-6">
                    <h3>{{breadcrumb.child}}</h3>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12">
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="display" id="basic-1">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>User</th>
                                        <th>Rating</th>
                                        <th>Review</th>
                                        <th>Liked Features</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for review in app_reviews %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ review.user.username|default:"Anonymous" }}</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                {% for i in "12345" %}
                                                    {% if forloop.counter <= review.rating %}
                                                        <i class="fa fa-star text-warning"></i>
                                                    {% else %}
                                                        <i class="fa fa-star text-secondary"></i>
                                                    {% endif %}
                                                {% endfor %}
                                                <span class="ms-2"></span>
                                            </div>
                                        </td>
                                        <td>{{ review.review|truncatechars:50 }}</td>
                                        <td>
                                            {% for feature in review.features.all %}
                                                <span class="feature-badge">{{ feature.feature.name_en }}</span>
                                            {% empty %}
                                                -
                                            {% endfor %}
                                        </td>
                                        <td>{{ review.created_at|date:"Y-m-d" }}</td>
                                        <td>
                                            <div class="action-menu-container" style="position: relative; display: inline-block;">
                                                <a href="#" class="three-dots-menu" onclick="toggleMenu(this)">
                                                    <i data-feather="more-vertical"></i>
                                                </a>
                                                <div class="action-card" style="
                                                    display: none;
                                                    position: absolute;
                                                    top: 100%;
                                                    right: 0;
                                                    background: #fff;
                                                    border: 1px solid #ccc;
                                                    border-radius: 4px;
                                                    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
                                                    z-index: 10;
                                                    width: auto;
                                                ">
                                                    <ul style="list-style: none; padding: 0; margin: 0;">
                                                        <li style="padding: 8px 12px;">
                                                            <a style="font-size: small" href="#" class="view-review-btn" 
                                                               data-review-id="{{ review.id }}"
                                                               data-review-user="{{ review.user.username|default:'Anonymous' }}"
                                                               data-review-user-id="{{ review.user.id|default:0 }}"
                                                               data-review-rating="{{ review.rating }}"
                                                               data-review-review="{{ review.review }}"
                                                               data-review-features="{% for feature in review.features.all %}{{ feature.feature.name_en }}{% if not forloop.last %},{% endif %}{% endfor %}"
                                                               data-review-date="{{ review.created_at|date:'Y-m-d H:i' }}">
                                                               View
                                                            </a>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View Review Modal -->
<div class="modal fade" id="viewAppReviewModal" tabindex="-1" aria-labelledby="viewAppReviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewAppReviewModalLabel">Review Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="user-info">
                    <div class="user-avatar" id="view-user-avatar">A</div>
                    <div>
                        <h6 class="mb-1" id="view-user">Anonymous User</h6>
                        <small class="text-muted" id="view-date">Date not available</small>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="review-detail-card">
                            <h6 class="review-detail-title">Rating Details</h6>
                            <div class="review-stars" id="view-rating-stars"></div>
                            <div class="d-flex align-items-center">
                                <span class="me-2">Rating:</span>
                                <strong id="view-rating-value">0</strong>/5
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="review-detail-card">
                            <h6 class="review-detail-title">Liked Features</h6>
                            <div class="features-container" id="view-features-container">
                                <!-- Features will be added here dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="review-detail-card">
                    <h6 class="review-detail-title">Review Content</h6>
                    <div class="review-content" id="view-review">
                        No review content available.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script src="{% static 'assets/js/datatable/datatables/jquery.dataTables.min.js'%}"></script>
<script src="{% static 'assets/js/datatable/datatables/datatable.custom.js'%}"></script>
<script src="{% static 'assets/js/tooltip-init.js'%}"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
    // Initialize DataTable with destroy option
    $('#basic-1').DataTable({
        "destroy": true
    });
    
    // View Review Modal Handler
    const viewAppReviewModal = new bootstrap.Modal(document.getElementById('viewAppReviewModal'));
    
    // Handle click on view review buttons using event delegation
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('view-review-btn') || e.target.closest('.view-review-btn')) {
            e.preventDefault();
            const button = e.target.classList.contains('view-review-btn') ? e.target : e.target.closest('.view-review-btn');
            
            // Close any open action menus first
            document.querySelectorAll('.action-card').forEach(card => {
                card.style.display = 'none';
            });
            
            // Get all data attributes
            const user = button.getAttribute('data-review-user');
            const userId = button.getAttribute('data-review-user-id');
            const rating = parseInt(button.getAttribute('data-review-rating'));
            const review = button.getAttribute('data-review-review');
            const features = button.getAttribute('data-review-features');
            const date = button.getAttribute('data-review-date');
            
            // Set user information
            document.getElementById('view-user').textContent = user;
            document.getElementById('view-user-avatar').textContent = user.charAt(0).toUpperCase();
            document.getElementById('view-date').textContent = date || 'Date not available';
            
            // Create star rating display
            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
                starsHtml += `<i class="fa fa-star${i <= rating ? ' text-warning' : ' text-secondary'}"></i> `;
            }
            document.getElementById('view-rating-stars').innerHTML = starsHtml;
            document.getElementById('view-rating-value').textContent = rating;
            
            // Set review content
            document.getElementById('view-review').textContent = review || 'No review content available.';
            
            // Set liked features
            const featuresContainer = document.getElementById('view-features-container');
            featuresContainer.innerHTML = ''; // Clear previous features
            
            if (features) {
                const featureNames = features.split(',');
                featureNames.forEach(name => {
                    if (name.trim()) {
                        const badge = document.createElement('span');
                        badge.className = 'feature-badge';
                        badge.textContent = name.trim();
                        featuresContainer.appendChild(badge);
                    }
                });
            }
            
            if (featuresContainer.children.length === 0) {
                featuresContainer.innerHTML = '-';
            }
            
            // Show the modal
            viewAppReviewModal.show();
        }
    });

    // Toggle action menu and handle outside clicks
    document.addEventListener('click', function(event) {
        const isMenuClick = event.target.closest('.three-dots-menu');
        const isActionCardClick = event.target.closest('.action-card');
        
        // Close all menus if clicking outside
        if (!isMenuClick && !isActionCardClick) {
            document.querySelectorAll('.action-card').forEach(card => {
                card.style.display = 'none';
            });
        }
        
        // Handle menu button click
        if (isMenuClick) {
            event.preventDefault();
            const actionCard = isMenuClick.nextElementSibling;
            const isVisible = actionCard.style.display === 'block';
            
            // Close all other menus first
            document.querySelectorAll('.action-card').forEach(card => {
                if (card !== actionCard) {
                    card.style.display = 'none';
                }
            });
            
            // Toggle current menu
            actionCard.style.display = isVisible ? 'none' : 'block';
        }
    });
});
</script>
{% endblock %}