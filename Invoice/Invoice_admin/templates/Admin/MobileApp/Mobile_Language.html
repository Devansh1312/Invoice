{% extends 'base.html' %} 
{% load custom_filters %} 
{% load static %} 
{% load sass_tags %} 

{% block css %}
<!-- Plugins css start-->
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/datatables.scss' %}">
<!-- Plugins css Ends--> 
{% endblock %} 

<style>
    .is-invalid {
        border-color: #dc3545;
        background-color: #f8d7da;
    }
</style> 

{% block title %}Mobile App Language Key-Value{% endblock %} 

{% block content %} 
<div class="page-body">
    <div class="container-fluid">
        <div class="page-title">
            <div class="row">
                <div class="col-6">
                    <h3>{{breadcrumb.child}}</h3>
                </div>
                <div class="col-6">
                    <ol class="breadcrumb">
                        <button class="btn btn-pill btn-outline-primary-2x ml-auto" data-bs-toggle="modal" data-bs-target="#addPlayingPositionModal">Add Key-Value</button>
                    </ol>
                </div>
            </div>
        </div>
        <div class="row">
            <!-- Report List -->
            <div class="col-sm-12">
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="display" id="mobile-language-table">
                                <thead>
                                    <tr>
                                        <th data-data="id">ID</th>
                                        <th data-data="key1">Key</th>
                                        <th data-data="value_en">Value (English)</th>
                                        <th data-data="value_ar">Value (Arabic)</th>
                                        <th data-data="actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Add Report Modal -->
        <div class="modal fade" id="addPlayingPositionModal" tabindex="-1" aria-labelledby="addPlayingPositionModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addPlayingPositionModalLabel">Add Key Values</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form method="post" action="{% url 'multi_language_create' %}" id="addPlayingPositionForm" enctype="multipart/form-data"> 
                            {% csrf_token %} 
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label for="add_key1" class="form-label">Key</label>
                                    <input type="text" class="form-control" id="add_key1" name="key1" placeholder="Enter Key" />
                                    <div class="invalid-feedback" id="add_key1-error"></div>
                                </div>
                                <div class="col-6 mb-3">
                                    <label for="add_value_en" class="form-label">Value in English</label>
                                    <input type="text" class="form-control" id="add_value_en" name="value_en" placeholder="Enter Value" />
                                    <div class="invalid-feedback" id="add_value_en-error"></div>
                                </div>
                                <div class="col-6 mb-3">
                                    <label for="add_value_ar" class="form-label">Value in Arabic</label>
                                    <input type="text" class="form-control" id="add_value_ar" name="value_ar" placeholder="Enter Value" />
                                    <div class="invalid-feedback" id="add_value_ar-error"></div>
                                </div>
                                <button type="submit" class="btn btn-primary">Add Key - Value</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Edit Report Modal -->
        <div class="modal fade" id="editPlayingPositionModal" tabindex="-1" aria-labelledby="editPlayingPositionModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editPlayingPositionModalLabel">Edit Key - Value</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form method="post" id="editPlayingPositionForm" enctype="multipart/form-data"> 
                            {% csrf_token %} 
                            <div class="row">
                                <input type="hidden" id="playingpositionsId" name="id" />
                                <div class="col-sm-12 mb-3">
                                    <label for="edit_key1" class="form-label">Key</label>
                                    <input type="text" class="form-control" id="edit_key1" name="key1" placeholder="Enter Key" />
                                    <div class="invalid-feedback" id="edit_key1-error"></div>
                                </div>
                                <div class="col-6 mb-3">
                                    <label for="edit_value_en" class="form-label">Value in English</label>
                                    <input type="text" class="form-control" id="edit_value_en" name="value_en" placeholder="Enter Value" />
                                    <div class="invalid-feedback" id="edit_value_en-error"></div>
                                </div>
                                <div class="col-6 mb-3">
                                    <label for="edit_value_ar" class="form-label">Value in Arabic</label>
                                    <input type="text" class="form-control" id="edit_value_ar" name="value_ar" placeholder="Enter Value" />
                                    <div class="invalid-feedback" id="edit_value_ar-error"></div>
                                </div>
                                <button type="submit" class="btn btn-primary">Update Key - Value</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div> 
</div>

<!-- Delete Key-Value Modal -->
<div class="modal fade" id="MobileLanguageModal" tabindex="-1" aria-labelledby="MobileLanguageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="MobileLanguageModalLabel">Delete Key-Value</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form method="post" action="" id="DeleteMobileLanguageForm">
            {% csrf_token %}
            <input type="hidden" id="mobile_language_id" name="id">
            <p>Are you sure you want to delete this Key Value?</p>
            <button type="submit" class="btn btn-danger">Delete Key-Value</button>
          </form>
        </div>
      </div>
    </div>
</div>
  
{% endblock %} 

{% block script %} 
<script src="{% static 'assets/js/datatable/datatables/jquery.dataTables.min.js'%}"></script>
<script src="{% static 'assets/js/datatable/datatables/datatable.custom.js'%}"></script>
<script src="{% static 'assets/js/tooltip-init.js'%}"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Initialize DataTable with server-side processing
        var table = $('#mobile-language-table').DataTable({
            "processing": true,
            "serverSide": true,
            "ajax": {
                "url": window.location.href,
                "type": "GET",
                "data": function(d) {
                    // You can add additional parameters here if needed
                }
            },
            "columns": [
                {"data": "id"},
                {"data": "key1"},
                {"data": "value_en"},
                {"data": "value_ar"},
                {
                    "data": "actions",
                    "render": function(data, type, row) {
                        return `
                            <div class="action-menu-container" style="position: relative; display: inline-block;">
                                <a href="#" class="three-dots-menu">
                                    <i data-feather="more-vertical"></i>
                                </a>
                                <div class="action-card" style="display: none; position: absolute; top: 100%; right: 0; background: #fff; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1); z-index: 10; width: auto;">
                                    <ul style="list-style: none; padding: 0; margin: 0;">
                                        <li style="padding: 8px 12px;">
                                            <a style="font-size: small" href="#" data-bs-toggle="modal" data-bs-target="#editPlayingPositionModal" 
                                                data-playingpositions-id="${row.actual_id}" 
                                                data-playingpositions-value_en="${row.value_en}" 
                                                data-playingpositions-value_ar="${row.value_ar}" 
                                                data-playingpositions-key1="${row.key1}"> 
                                                Edit 
                                            </a>
                                        </li>
                                        <li style="padding: 8px 12px; border-top: 1px solid #eee;">
                                            <a style="font-size: small;" href="#" data-bs-toggle="modal" data-bs-target="#MobileLanguageModal" 
                                            data-MobileLanguage-id="${row.actual_id}">
                                            Delete
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        `;
                    }
                }
            ],
            "responsive": true,
            "lengthMenu": [10, 25, 50, 100],
            "pageLength": 10,
            "drawCallback": function() {
                // Re-initialize Feather icons after table draw
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
                
                // Re-attach event listeners for three-dot menus
                initializeThreeDotsMenu();
            }
        });

        // Function to initialize three-dots menu functionality
        function initializeThreeDotsMenu() {
            // Remove any existing event listeners to prevent duplicates
            $(document).off('click', '.three-dots-menu');
            $(document).off('click', document);
            
            // Add click event for three-dots menu
            $(document).on('click', '.three-dots-menu', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Close all other menus first
                $('.action-card').not($(this).next('.action-card')).hide();
                
                // Toggle this menu
                $(this).next('.action-card').toggle();
            });
            
            // Close menus when clicking outside
            $(document).on('click', function(e) {
                if (!$(e.target).closest('.action-menu-container').length) {
                    $('.action-card').hide();
                }
            });
        }

        // Refresh table after modal operations
        function refreshTable() {
            table.ajax.reload(null, false);
        }

        // Form validation function
        function validateForm(form) {
            let isValid = true;
            const formId = form.id;
            const prefix = formId === 'addPlayingPositionForm' ? 'add_' : 'edit_';

            // Check each required field
            const fields = ['key1', 'value_en', 'value_ar'];
            fields.forEach(field => {
                const input = form.querySelector(`#${prefix}${field}`);
                const errorDiv = form.querySelector(`#${prefix}${field}-error`);
                
                if (!input.value.trim()) {
                    input.classList.add('is-invalid');
                    errorDiv.textContent = 'This field is required.';
                    errorDiv.style.color = 'red';
                    isValid = false;
                } else {
                    input.classList.remove('is-invalid');
                    errorDiv.textContent = '';
                }
            });

            return isValid;
        }

        // Centralized SweetAlert function to use base.html styling
        function showBaseSweetAlert(type, message) {
            const iconTypes = {
                'success': 'success',
                'error': 'error',
                'warning': 'warning',
                'info': 'info'
            };
            
            const backgrounds = {
                'success': '#d4edda',
                'error': '#f8d7da',
                'warning': '#fff3cd',
                'info': '#d1ecf1'
            };
            
            const iconColors = {
                'success': '#0f5132',
                'error': '#842029',
                'warning': '#664d03',
                'info': '#055160'
            };

            Swal.fire({
                icon: iconTypes[type] || 'info',
                text: message,
                background: backgrounds[type] || '#e2e3e5',
                iconColor: iconColors[type] || '#41464b',
                customClass: {
                    popup: 'alert alert-dismissible fade show',
                    title: 'alert-heading',
                    content: 'alert-text',
                },
                position: 'top-end',
                toast: true,
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                showCloseButton: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer)
                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                }
            });
        }

        // Handle Add form submission
        $('#addPlayingPositionForm').on('submit', function(e) {
            e.preventDefault();
            
            if (!validateForm(this)) {
                return;
            }

            const form = $(this);
            const submitButton = form.find('button[type="submit"]');
            
            submitButton.prop('disabled', true).text('Adding...');
            
            $.ajax({
                type: form.attr('method'),
                url: form.attr('action'),
                data: form.serialize(),
                success: function(response) {
                    if (response.success) {
                        $('#addPlayingPositionModal').modal('hide');
                        form[0].reset();
                        refreshTable();
                        showBaseSweetAlert('success', response.message || 'Key-Value added successfully.');
                    } else {
                        // Handle field-specific errors
                        if (response.errors) {
                            Object.keys(response.errors).forEach(field => {
                                const input = form.find(`#add_${field}`);
                                const errorDiv = form.find(`#add_${field}-error`);
                                input.addClass('is-invalid');
                                errorDiv.text(response.errors[field][0]);
                                errorDiv.css('color', 'red');
                            });
                        } else {
                            showBaseSweetAlert('error', response.message || 'Operation failed');
                        }
                    }
                },
                error: function(xhr) {
                    console.error('Error:', xhr);
                    showBaseSweetAlert('error', 'An error occurred while adding the language key.');
                },
                complete: function() {
                    submitButton.prop('disabled', false).text('Add Key - Value');
                }
            });
        });

        // Handle Edit form submission
        $('#editPlayingPositionForm').on('submit', function(e) {
            e.preventDefault();
            
            if (!validateForm(this)) {
                return;
            }

            const form = $(this);
            const submitButton = form.find('button[type="submit"]');
            
            submitButton.prop('disabled', true).text('Updating...');
            
            $.ajax({
                type: form.attr('method'),
                url: form.attr('action'),
                data: form.serialize(),
                success: function(response) {
                    if (response.success) {
                        $('#editPlayingPositionModal').modal('hide');
                        refreshTable();
                        showBaseSweetAlert('success', response.message || 'Key-Value updated successfully.');
                    } else {
                        // Handle field-specific errors
                        if (response.errors) {
                            Object.keys(response.errors).forEach(field => {
                                const input = form.find(`#edit_${field}`);
                                const errorDiv = form.find(`#edit_${field}-error`);
                                input.addClass('is-invalid');
                                errorDiv.text(response.errors[field][0]);
                                errorDiv.css('color', 'red');
                            });
                        } else {
                            showBaseSweetAlert('error', response.message || 'Operation failed');
                        }
                    }
                },
                error: function(xhr) {
                    console.error('Error:', xhr);
                    showBaseSweetAlert('error', 'An error occurred while updating the language key.');
                },
                complete: function() {
                    submitButton.prop('disabled', false).text('Update Key - Value');
                }
            });
        });

        // Handle Delete form submission
        $('#DeleteMobileLanguageForm').on('submit', function(e) {
            e.preventDefault();
            
            const form = $(this);
            const submitButton = form.find('button[type="submit"]');
            
            submitButton.prop('disabled', true).text('Deleting...');
            
            $.ajax({
                type: form.attr('method'),
                url: form.attr('action'),
                data: form.serialize(),
                success: function(response) {
                    if (response.success) {
                        $('#MobileLanguageModal').modal('hide');
                        refreshTable();
                        showBaseSweetAlert('success', response.message || 'Key-Value deleted successfully.');
                    } else {
                        showBaseSweetAlert('error', response.message || 'Operation failed');
                    }
                },
                error: function(xhr) {
                    console.error('Error:', xhr);
                    showBaseSweetAlert('error', 'An error occurred while deleting the language key.');
                },
                complete: function() {
                    submitButton.prop('disabled', false).text('Delete Key-Value');
                }
            });
        });

        // Edit Modal Event Handler
        var editPlayingPositionModal = document.getElementById("editPlayingPositionModal");
        if (editPlayingPositionModal) {
            editPlayingPositionModal.addEventListener("show.bs.modal", function(event) {
                var button = event.relatedTarget;
                var playingpositionsId = button.getAttribute("data-playingpositions-id");
                var playingpositionsvalue_en = button.getAttribute("data-playingpositions-value_en");
                var playingpositionsvalue_ar = button.getAttribute("data-playingpositions-value_ar");
                var playingpositionskey = button.getAttribute("data-playingpositions-key1");

                var form = document.getElementById("editPlayingPositionForm");
                // Update form action to point to the correct report ID for editing
                form.action = "{% url 'multi_language_edit' 0 %}".replace("0", playingpositionsId);
                
                // Set the values in the form
                form.querySelector("#playingpositionsId").value = playingpositionsId;
                form.querySelector("#edit_value_en").value = playingpositionsvalue_en || "";
                form.querySelector("#edit_value_ar").value = playingpositionsvalue_ar || "";
                form.querySelector("#edit_key1").value = playingpositionskey || "";
                
                // Clear any previous validation errors
                form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
                form.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');
            });
        }
        
        // Delete Modal Event Handler
        var MobileLanguageModal = document.getElementById('MobileLanguageModal');
        if (MobileLanguageModal) {
            MobileLanguageModal.addEventListener('show.bs.modal', function(event) {
                var button = event.relatedTarget;
                var MobileLanguageID = button.getAttribute('data-MobileLanguage-id');
                var deleteForm = document.getElementById('DeleteMobileLanguageForm');
                deleteForm.action = "{% url 'multi_language_delete' 0 %}".replace('0', MobileLanguageID);
                document.getElementById('mobile_language_id').value = MobileLanguageID;
            });
        }

        // Clear validation errors on input change
        $('input').on('input', function() {
            const input = $(this);
            if (input.val().trim() !== '') {
                input.removeClass('is-invalid');
                const errorId = input.attr('id') + '-error';
                $('#' + errorId).text('');
            }
        });

        // Clear form when add modal is closed
        $('#addPlayingPositionModal').on('hidden.bs.modal', function() {
            const form = document.getElementById('addPlayingPositionForm');
            form.reset();
            form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            form.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');
        });
        
        // Initialize three-dots menu on page load
        initializeThreeDotsMenu();
    });
</script>
{% endblock %}