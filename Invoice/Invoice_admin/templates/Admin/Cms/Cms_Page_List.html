{% extends 'base.html' %} 
{% load custom_filters %} 
{% load static %} 
{% load sass_tags %} 

{% block css %}
<!-- Plugins css start-->
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/datatables.scss' %}">
<!-- Plugins css Ends--> 
{% endblock %} 

<style>
    .is-invalid {
        border-color: #dc3545;
        background-color: #f8d7da;
    }
</style> 

{% block title %}CMS Management{% endblock %} 
{% block content %} 
<div class="page-body">
    <div class="container-fluid">
        <div class="page-title">
            <div class="row">
                <div class="col-6">
                    <h3>{{breadcrumb.child}}</h3>
                </div>
                <div class="col-6">
                    <ol class="breadcrumb">
                        <button class="btn btn-pill btn-outline-primary-2x ml-auto" data-bs-toggle="modal" data-bs-target="#addCMSModal">Add CMS</button>
                    </ol>
                </div>
            </div>
        </div>
        <div class="row">
            <!-- CMS List -->
            <div class="col-sm-12">
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="display" id="basic-1">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Title (English)</th>
                                        <th>Title (Arabic)</th>
                                        <th>Description (English)</th>
                                        <th>Description (Arabic)</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody> 
                                    {% for cms in cms_list %} 
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ cms.title_en|truncatechars:50 }}</td>
                                        <td>{{ cms.title_ar|truncatechars:50 }}</td>
                                        <td>{{ cms.description_en|truncatechars:50|safe }}</td>
                                        <td>{{ cms.description_ar|truncatechars:50|safe }}</td>
                                        <td>
                                            <div class="action-menu-container" style="position: relative; display: inline-block;">
                                                <a href="#" class="three-dots-menu" onclick="toggleMenu(this)">
                                                    <i data-feather="more-vertical"></i>
                                                </a>
                                                <div class="action-card" style="
                                                    display: none;
                                                    position: absolute;
                                                    top: 100%;
                                                    right: 0;
                                                    background: #fff;
                                                    border: 1px solid #ccc;
                                                    border-radius: 4px;
                                                    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
                                                    z-index: 10;
                                                    width: auto;
                                                ">
                                                    <ul style="list-style: none; padding: 0; margin: 0;">
                                                        <li style="padding: 8px 12px;">
                                                            <a style="font-size: small" href="#" data-bs-toggle="modal" data-bs-target="#editCMSModal" 
                                                            data-cms-id="{{ cms.id }}" 
                                                            data-cms-title_en="{{ cms.title_en }}" 
                                                            data-cms-title_ar="{{ cms.title_ar }}"
                                                            data-cms-description_en="{{ cms.description_en }}"
                                                            data-cms-description_ar="{{ cms.description_ar }}"> Edit </a>
                                                        </li>
                                                        <li style="padding: 8px 12px; border-top: 1px solid #eee;">
                                                            <a style="font-size: small;" href="#" data-bs-toggle="modal" data-bs-target="#deleteCMSModal" data-cms-id="{{ cms.id }}">
                                                            Delete </a>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </td>
                                    </tr> 
                                    {% endfor %} 
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Add CMS Modal -->
        <div class="modal fade" id="addCMSModal" tabindex="-1" aria-labelledby="addCMSModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addCMSModalLabel">Add CMS</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form method="post" action="{% url 'cms_create' %}" id="addCMSForm" enctype="multipart/form-data"> 
                            {% csrf_token %} 
                            <div class="row">
                                <div class="col-6 mb-3">
                                    <label for="title_en" class="form-label">Title (English)</label>
                                    <input type="text" class="form-control" id="title_en" name="title_en" placeholder="Enter title in English">
                                    <div class="invalid-feedback" id="title_en-error"></div>
                                </div>
                                <div class="col-6 mb-3">
                                    <label for="title_ar" class="form-label">Title (Arabic)</label>
                                    <input type="text" class="form-control" id="title_ar" name="title_ar" placeholder="Enter title in Arabic">
                                    <div class="invalid-feedback" id="title_ar-error"></div>
                                </div>
                                <div class="col-6 mb-3">
                                    <label for="description_en" class="form-label">Description (English)</label>
                                    <textarea class="form-control" id="description_en" name="description_en" rows="5" placeholder="Enter description in English"></textarea>
                                    <div class="invalid-feedback" id="description_en-error"></div>
                                </div>
                                <div class="col-6 mb-3">
                                    <label for="description_ar" class="form-label">Description (Arabic)</label>
                                    <textarea class="form-control" id="description_ar" name="description_ar" rows="5" placeholder="Enter description in Arabic"></textarea>
                                    <div class="invalid-feedback" id="description_ar-error"></div>
                                </div>
                                <button type="submit" class="btn btn-primary">Add CMS</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- Edit CMS Modal -->
        <div class="modal fade" id="editCMSModal" tabindex="-1" aria-labelledby="editCMSModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editCMSModalLabel">Edit CMS</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form method="post" id="editCMSForm" enctype="multipart/form-data"> 
                            {% csrf_token %} 
                            <div class="row">
                                <input type="hidden" id="edit-cmsId" name="id" />
                                <div class="col-6 mb-3">
                                    <label for="edit-title_en" class="form-label">Title (English)</label>
                                    <input type="text" class="form-control" id="edit-title_en" name="title_en" placeholder="Enter title in English">
                                    <div class="invalid-feedback" id="edit-title_en-error"></div>
                                </div>
                                <div class="col-6 mb-3">
                                    <label for="edit-title_ar" class="form-label">Title (Arabic)</label>
                                    <input type="text" class="form-control" id="edit-title_ar" name="title_ar" placeholder="Enter title in Arabic">
                                    <div class="invalid-feedback" id="edit-title_ar-error"></div>
                                </div>
                                <div class="col-6 mb-3">
                                    <label for="edit-description_en" class="form-label">Description (English)</label>
                                    <textarea class="form-control" id="edit-description_en" name="description_en" rows="5" placeholder="Enter description in English"></textarea>
                                    <div class="invalid-feedback" id="edit-description_en-error"></div>
                                </div>
                                <div class="col-6 mb-3">
                                    <label for="edit-description_ar" class="form-label">Description (Arabic)</label>
                                    <textarea class="form-control" id="edit-description_ar" name="description_ar" rows="5" placeholder="Enter description in Arabic"></textarea>
                                    <div class="invalid-feedback" id="edit-description_ar-error"></div>
                                </div>
                                <button type="submit" class="btn btn-primary">Update CMS</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div> 
</div>
<!-- Delete CMS Modal -->
<div class="modal fade" id="deleteCMSModal" tabindex="-1" aria-labelledby="deleteCMSModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteCMSModalLabel">Delete CMS</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form method="post" action="" id="deleteCMSForm">
            {% csrf_token %}
            <input type="hidden" id="cms_id" name="id">
            <p>Are you sure you want to delete this CMS?</p>
            <button type="submit" class="btn btn-danger">Delete CMS</button>
          </form>
        </div>
      </div>
    </div>
</div>
  
{% endblock %} 

{% block script %} 
<script src="{% static 'assets/js/datatable/datatables/jquery.dataTables.min.js'%}"></script>
<script src="{% static 'assets/js/datatable/datatables/datatable.custom.js'%}"></script>
<script src="{% static 'assets/js/tooltip-init.js'%}"></script>
<script src="https://cdn.ckeditor.com/ckeditor5/34.0.0/classic/ckeditor.js"></script>

<script>
    $(document).ready(function() {
        // Initialize CKEditor for Add Form
        let addEditorEn, addEditorAr;
        
        ClassicEditor
            .create(document.querySelector('#description_en'))
            .then(editor => {
                addEditorEn = editor;
            })
            .catch(error => {
                console.error(error);
            });

        ClassicEditor
            .create(document.querySelector('#description_ar'))
            .then(editor => {
                addEditorAr = editor;
            })
            .catch(error => {
                console.error(error);
            });

        // Initialize CKEditor for Edit Form when modal opens
        let editEditorEn, editEditorAr;
        
        $('#editCMSModal').on('show.bs.modal', function(event) {
            var button = event.relatedTarget;
            var cmsId = button.getAttribute("data-cms-id");
            var title_en = button.getAttribute("data-cms-title_en");
            var title_ar = button.getAttribute("data-cms-title_ar");
            var description_en = button.getAttribute("data-cms-description_en");
            var description_ar = button.getAttribute("data-cms-description_ar");

            var form = document.getElementById("editCMSForm");
            form.action = "{% url 'cms_edit' 0 %}".replace("0", cmsId);
            form.querySelector("#edit-cmsId").value = cmsId;
            form.querySelector("#edit-title_en").value = title_en || "";
            form.querySelector("#edit-title_ar").value = title_ar || "";

            // Initialize or update CKEditor for edit modal
            if (!editEditorEn) {
                ClassicEditor
                    .create(document.querySelector('#edit-description_en'))
                    .then(editor => {
                        editEditorEn = editor;
                        editor.setData(description_en || "");
                    })
                    .catch(error => {
                        console.error(error);
                    });
            } else {
                editEditorEn.setData(description_en || "");
            }

            if (!editEditorAr) {
                ClassicEditor
                    .create(document.querySelector('#edit-description_ar'))
                    .then(editor => {
                        editEditorAr = editor;
                        editor.setData(description_ar || "");
                    })
                    .catch(error => {
                        console.error(error);
                    });
            } else {
                editEditorAr.setData(description_ar || "");
            }
        });

        // Toggle action menu
        function toggleMenu(element) {
            var actionCard = $(element).next('.action-card');
            $('.action-card').not(actionCard).hide();
            actionCard.toggle();
        }

        // Hide action card when clicking outside
        $(document).click(function(event) {
            if (!$(event.target).closest('.action-menu-container').length) {
                $('.action-card').hide();
            }
        });

        // Delete CMS Modal
        $('#deleteCMSModal').on('show.bs.modal', function(event) {
            var button = event.relatedTarget;
            var cmsID = button.getAttribute('data-cms-id');
            var deleteForm = document.getElementById('deleteCMSForm');
            deleteForm.action = "{% url 'cms_delete' 0 %}".replace('0', cmsID);
        });

    });
    // Toggle the visibility of the action card
    document.querySelectorAll(".three-dots-menu").forEach(function(menu) {
            menu.addEventListener("click", function(event) {
                event.preventDefault();
                var actionCard = menu.nextElementSibling;
                actionCard.style.display = actionCard.style.display === "none" || actionCard.style.display === "" ? "block" : "none";
                // Close other open action cards
                document.querySelectorAll(".action-card").forEach(function(card) {
                    if (card !== actionCard) {
                        card.style.display = "none";
                    }
                });
            });
        });
</script>

{% endblock %}