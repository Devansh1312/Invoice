{% extends 'base.html' %}
{% load static %}
{% load sass_tags %}

{% block css %}
<!-- Plugins css start-->
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/datatables.scss' %}">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<!-- Plugins css Ends-->
{% endblock %}

{% block title %}Sub Admin List{% endblock %}

{% block content %}
<div class="page-body">
    <div class="container-fluid">
        <div class="page-title">
            <div class="row">
                <div class="col-6">
                    <h3>{{ breadcrumb.child }}</h3>
                </div>
                <div class="col-6 text-right">
                    <button class="btn btn-primary" data-toggle="modal" data-target="#addSubAdminModal">
                        Add Sub Admin
                    </button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12">
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="basic-1">
                                <thead>
                                    <tr>
                                        <th>No.</th>
                                        <th>Username</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user in subadmins %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ user.username }}</td>
                                        <td>{{ user.name }}</td>
                                        <td>{{ user.email }}</td>
                                        <td>{{ user.phone }}</td>
                                        <td>
                                            {% if user.is_active %}
                                                <span class="badge badge-success">Active</span>
                                            {% else %}
                                                <span class="badge badge-danger">Inactive</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="action-menu-container" style="position: relative; display: inline-block;">
                                                <a href="#" class="three-dots-menu">
                                                    <i data-feather="more-vertical"></i>
                                                </a>
                                                <div class="action-card" style="display: none; position: absolute; top: 100%; right: 0; background: #fff; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1); z-index: 10; width: auto;">
                                                    <ul style="list-style: none; padding: 0; margin: 0;">
                                                        <!-- Toggle Status Action -->
                                                        <li style="padding: 8px 12px; border-top: 1px solid #eee; font-size: small;">
                                                            <a href="#" class="toggle-status" data-id="{{ user.id }}" data-status="{% if user.is_active %}deactivate{% else %}activate{% endif %}">
                                                                {% if user.is_active %}Deactivate{% else %}Activate{% endif %}
                                                            </a>
                                                            <form id="status-form-{{ user.id }}" method="post" action="{% url 'subadmin_toggle_status' pk=user.id %}" style="display: none;">
                                                                {% csrf_token %}
                                                                <input type="hidden" name="source_page" value="subadmin_list">
                                                                <input type="hidden" name="title" value="Sub Admin">
                                                                <input type="hidden" name="status" value="{% if user.is_active %}deactivate{% else %}activate{% endif %}">
                                                            </form>
                                                        </li>
                                                        
                                                        <!-- Edit Action -->
                                                        <li style="padding: 8px 12px; border-top: 1px solid #eee; font-size: small;">
                                                            <a href="#" class="edit-subadmin" 
                                                                data-id="{{ user.id }}"
                                                                data-name="{{ user.name }}"
                                                                data-email="{{ user.email }}"
                                                                data-phone="{{ user.phone }}"
                                                                data-toggle="modal" 
                                                                data-target="#editSubAdminModal">
                                                                Edit
                                                            </a>
                                                        </li>
                                                        <li style="padding: 8px 12px; border-top: 1px solid #eee; font-size: small;">
                                                            <a href="{% url 'subadmin_detail' user.id %}" class="view-details">View</a>
                                                        </li>
                                                        
                                                        <!-- Delete Action -->
                                                        <!-- <li style="padding: 8px 12px; border-top: 1px solid #eee; font-size: small;">
                                                            <a href="#" class="delete-subadmin" 
                                                               data-id="{{ user.id }}"
                                                               data-name="{{ user.name }}"
                                                               data-toggle="modal" 
                                                               data-target="#deleteSubAdminModal">
                                                                Delete
                                                            </a>
                                                        </li> -->
                                                    </ul>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Sub Admin Modal -->
<div class="modal fade" id="addSubAdminModal" tabindex="-1" role="dialog" aria-labelledby="addSubAdminModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSubAdminModalLabel">Add Sub Admin</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="addSubAdminForm" method="post" action="{% url 'subadmin_create' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group">
                        <label for="name">Full Name</label>
                        <input type="text" class="form-control" id="name" name="name" >
                        <div class="invalid-feedback-name"></div>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="text" class="form-control" id="email" name="email">
                        <div class="invalid-feedback-email"></div>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone</label>
                        <input type="text" class="form-control" id="phone" name="phone">
                        <div class="invalid-feedback-phone"></div>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="password" name="password">
                            <div class="input-group-append">
                                <span class="input-group-text password-toggle" style="cursor: pointer;">
                                    <i class="fas fa-eye"></i>
                                </span>
                            </div>
                        </div>
                        <div class="invalid-feedback-password"></div>
                    </div>
                    <div class="form-group">
                        <label for="confirm_password">Confirm Password</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="confirm_password" name="confirm_password">
                            <div class="input-group-append">
                                <span class="input-group-text password-toggle" style="cursor: pointer;">
                                    <i class="fas fa-eye"></i>
                                </span>
                            </div>
                        </div>
                        <div class="invalid-feedback-confirm_password"></div>
                    </div>
                    <input type="hidden" name="source_page" value="subadmin_list">
                    <input type="hidden" name="title" value="Sub Admin">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Sub Admin</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Sub Admin Modal -->
<div class="modal fade" id="editSubAdminModal" tabindex="-1" role="dialog" aria-labelledby="editSubAdminModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSubAdminModalLabel">Edit Sub Admin</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="editSubAdminForm" method="post" action="">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group">
                        <label for="edit_name">Full Name</label>
                        <input type="text" class="form-control" id="edit_name" name="name">
                        <div class="invalid-feedback-edit_name"></div>
                    </div>
                    <div class="form-group">
                        <label for="edit_email">Email</label>
                        <input type="text" class="form-control" id="edit_email" name="email">
                        <div class="invalid-feedback-edit_email"></div>
                    </div>
                    <div class="form-group">
                        <label for="edit_phone">Phone</label>
                        <input type="text" class="form-control" id="edit_phone" name="phone">
                        <div class="invalid-feedback-edit_phone"></div>
                    </div>
                    <div class="form-group">
                        <label for="edit_password">New Password (leave blank to keep current)</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="edit_password" name="password">
                            <div class="input-group-append">
                                <span class="input-group-text password-toggle" style="cursor: pointer;">
                                    <i class="fas fa-eye"></i>
                                </span>
                            </div>
                        </div>
                        <div class="invalid-feedback-edit_password"></div>
                    </div>
                    <div class="form-group">
                        <label for="edit_confirm_password">Confirm New Password</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="edit_confirm_password" name="confirm_password">
                            <div class="input-group-append">
                                <span class="input-group-text password-toggle" style="cursor: pointer;">
                                    <i class="fas fa-eye"></i>
                                </span>
                            </div>
                        </div>
                        <div class="invalid-feedback-edit_confirm_password"></div>
                    </div>
                    <input type="hidden" name="source_page" value="subadmin_list">
                    <input type="hidden" name="title" value="Sub Admin">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Sub Admin</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Sub Admin Modal -->
<div class="modal fade" id="deleteSubAdminModal" tabindex="-1" role="dialog" aria-labelledby="deleteSubAdminModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteSubAdminModalLabel">Delete Sub Admin</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="deleteSubAdminForm" method="post" action="">
                    {% csrf_token %}
                    <input type="hidden" id="subadmin_id" name="id">
                    <input type="hidden" name="source_page" value="subadmin_list">
                    <input type="hidden" name="title" value="Sub Admin">
                    <p>Are you sure you want to delete <strong><span id="subadmin_name"></span></strong>?</p>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scriptcontent %}
<!-- Required JS for Bootstrap -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<!-- Plugins JS -->
<script src="{% static 'assets/js/datatable/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'assets/js/datatable/datatables/datatable.custom.js' %}"></script>
<script src="{% static 'assets/js/tooltip-init.js' %}"></script>
<script src="{% static 'assets/js/icons/feather-icon/feather.min.js' %}"></script>
<script src="{% static 'assets/js/icons/feather-icon/feather-icon.js' %}"></script>

<script>
$(document).ready(function() {
    // Initialize Feather Icons
    feather.replace();

    // Action menu toggle
    document.querySelectorAll('.three-dots-menu').forEach(function(menu) {
        menu.addEventListener('click', function(event) {
            event.preventDefault();
            var actionCard = menu.nextElementSibling;
            actionCard.style.display = (actionCard.style.display === 'none' || actionCard.style.display === '') ? 'block' : 'none';
            // Close other open action cards
            document.querySelectorAll('.action-card').forEach(function(card) {
                if (card !== actionCard) {
                    card.style.display = 'none';
                }
            });
        });
    });
    
    // Hide action card if clicking outside
    document.addEventListener('click', function(event) {
        var isClickInside = event.target.closest('.action-menu-container');
        if (!isClickInside) {
            document.querySelectorAll('.action-card').forEach(function(card) {
                card.style.display = 'none';
            });
        }
    });
    
    // Toggle User Status
    $('.toggle-status').on('click', function(e) {
        e.preventDefault();
        var userId = $(this).data('id');
        $('#status-form-' + userId).submit();
    });

    // Edit Sub Admin - Load data directly from data attributes
    $('.edit-subadmin').on('click', function(e) {
        e.preventDefault();
        
        // Get data from data attributes
        var userId = $(this).data('id');
        var name = $(this).data('name');
        var email = $(this).data('email');
        var phone = $(this).data('phone');
        
        // Populate the form fields
        $('#edit_name').val(name);
        $('#edit_email').val(email);
        $('#edit_phone').val(phone);
        
        // Update the form action URL
        $('#editSubAdminForm').attr('action', '/subadmins/' + userId + '/edit/');
    });

    // Delete Sub Admin - Setup modal with user data
    $('.delete-subadmin').on('click', function(e) {
        e.preventDefault();
        
        var userId = $(this).data('id');
        var userName = $(this).data('name');
        
        // Set the form action URL
        $('#deleteSubAdminForm').attr('action', '/subadmins/' + userId + '/delete/');
        
        // Set the hidden input value
        $('#subadmin_id').val(userId);
        
        // Display the user's name in the confirmation message
        $('#subadmin_name').text(userName);
    });

    // Password toggle functionality (eye icon)
    $('.password-toggle').on('click', function() {
        const input = $(this).closest('.input-group').find('input');
        const icon = $(this).find('i');
        
        if (input.attr('type') === 'password') {
            input.attr('type', 'text');
            icon.removeClass('fa-eye').addClass('fa-eye-slash');
        } else {
            input.attr('type', 'password');
            icon.removeClass('fa-eye-slash').addClass('fa-eye');
        }
    });

    // Add Sub Admin Form Validation
    $('#addSubAdminForm').on('submit', function(e) {
        e.preventDefault();
        let isValid = true;
        
        // Reset error messages
        $('.invalid-feedback').text('');
        $('.is-invalid').removeClass('is-invalid');
        
        // Validate name
        if (!$('#name').val().trim()) {
            $('#name').addClass('is-invalid');
            $('.invalid-feedback-name').text('Name is required').css('color', 'red');
            isValid = false;
        }
        
        // Validate email
        const email = $('#email').val().trim();
        if (!email) {
            $('#email').addClass('is-invalid');
            $('.invalid-feedback-email').text('Email is required').css('color', 'red');
            isValid = false;
        } else if (!isValidEmail(email)) {
            $('#email').addClass('is-invalid');
            $('.invalid-feedback-email').text('Please enter a valid email').css('color', 'red');
            isValid = false;
        }
        
        // Validate phone
        if (!$('#phone').val().trim()) {
            $('#phone').addClass('is-invalid');
            $('.invalid-feedback-phone').text('Phone is required').css('color', 'red');
            isValid = false;
        }
        
        // Validate password
        const password = $('#password').val();
        if (!password) {
            $('#password').addClass('is-invalid');
            $('.invalid-feedback-password').text('Password is required').css('color', 'red');
            isValid = false;
        } else if (password.length < 8) {
            $('#password').addClass('is-invalid');
            $('.invalid-feedback-password').text('Password must be at least 8 characters').css('color', 'red');
            isValid = false;
        }
        
        // Validate confirm password
        const confirmPassword = $('#confirm_password').val();
        if (!confirmPassword) {
            $('#confirm_password').addClass('is-invalid');
            $('.invalid-feedback-confirm_password').text('Please confirm your password').css('color', 'red');
            isValid = false;
        } else if (password !== confirmPassword) {
            $('#confirm_password').addClass('is-invalid');
            $('.invalid-feedback-confirm_password').text('Passwords do not match').css('color', 'red');
            isValid = false;
        }
        
        if (isValid) {
            this.submit();
        }
    });

    // Edit Sub Admin Form Validation
    $('#editSubAdminForm').on('submit', function(e) {
        e.preventDefault();
        let isValid = true;
        
        // Reset error messages
        $('.invalid-feedback').text('');
        $('.is-invalid').removeClass('is-invalid');
        
        // Validate name
        if (!$('#edit_name').val().trim()) {
            $('#edit_name').addClass('is-invalid');
            $('.invalid-feedback-edit_name').text('Name is required').css('color', 'red');
            isValid = false;
        }
        
        // Validate email
        const email = $('#edit_email').val().trim();
        if (!email) {
            $('#edit_email').addClass('is-invalid');
            $('.invalid-feedback-edit_email').text('Email is required').css('color', 'red');
            isValid = false;
        } else if (!isValidEmail(email)) {
            $('#edit_email').addClass('is-invalid');
            $('.invalid-feedback-edit_email').text('Please enter a valid email').css('color', 'red');
            isValid = false;
        }
        
        // Validate phone
        if (!$('#edit_phone').val().trim()) {
            $('#edit_phone').addClass('is-invalid');
            $('.invalid-feedback-edit_phone').text('Phone is required').css('color', 'red');
            isValid = false;
        }
        
        // Validate password if provided
        const password = $('#edit_password').val();
        const confirmPassword = $('#edit_confirm_password').val();
        
        if (password || confirmPassword) {
            if (!password) {
                $('#edit_password').addClass('is-invalid');
                $('.invalid-feedback-edit_password').text('Password is required if changing').css('color', 'red');
                isValid = false;
            } else if (password.length < 8) {
                $('#edit_password').addClass('is-invalid');
                $('.invalid-feedback-edit_password').text('Password must be at least 8 characters').css('color', 'red');
                isValid = false;
            }
            
            if (!confirmPassword) {
                $('#edit_confirm_password').addClass('is-invalid');
                $('.invalid-feedback-edit_confirm_password').text('Please confirm your password').css('color', 'red');
                isValid = false;
            } else if (password !== confirmPassword) {
                $('#edit_confirm_password').addClass('is-invalid');
                $('.invalid-feedback-edit_confirm_password').text('Passwords do not match').css('color', 'red');
                isValid = false;
            }
        }
        
        if (isValid) {
            this.submit();
        }
    });

    // Helper function to validate email
    function isValidEmail(email) {
        const re = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
        return re.test(String(email).toLowerCase());
    }
});
</script>
{% endblock %}