{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}
{% load sass_tags %}

{% block css %}
<!-- Plugins css start-->
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/datatables.scss' %}">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.5.0/nouislider.min.css">
<style>
    @media (max-width: 576px) {
        .action-card {
            width: 120px;
        }
    }
    .filter-section {
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 5px;
        background-color: #f8f9fa;
    }
    .filter-row {
        margin-bottom: 15px;
    }
    .filter-btn {
        margin-right: 10px;
    }
    .select2-container {
        width: 100% !important;
    }
    
    /* Fixed styling for Select2 multiple selections */
    .select2-container .select2-selection--multiple .select2-selection__choice {
        padding-right: 20px !important;
        position: relative;
        margin-top: 4px;
        margin-right: 5px;
        overflow: hidden;
    }

    .select2-container .select2-selection--multiple .select2-selection__choice__remove {
        position: absolute;
        right: 3px;
        top: 0;
        font-weight: bold;
    }

    /* Ensure the selection container has enough height */
    .select2-container .select2-selection--multiple {
        min-height: 38px;
    }

    /* Make the text truncate properly when too long */
    .select2-container .select2-selection--multiple .select2-selection__choice__display {
        max-width: 95%;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
        color: #fff !important;
        float: inline-end !important;
    }
    .select2-container .select2-selection--multiple .select2-selection__choice__remove {
        position: relative !important;
        right: 3px;
        top: 0;
        font-weight: bold;
    }
    
    /* noUiSlider custom styling */
    .noUi-target {
        margin-top: 15px;
        margin-bottom: 25px;
    }
    .noUi-connect {
        background: #7366ff;
    }
    .noUi-handle {
        width: 10px;  /* Slightly smaller handle */
        height: 8px;
        top: -5px;    /* Adjusted to match new height */
        right: -8px;  /* Adjusted to match new width */
        border-radius: 50%;
        background: #7366ff;
        box-shadow: none;
        border: 2px solid white;
    }
    .noUi-handle:before, .noUi-handle:after {
        display: none;
    }
    .noUi-tooltip {
        background: #7366ff;
        color: white;
        border: none;
        padding: 2px 6px;
        font-size: 08px;
        border-radius: 3px;
        bottom: -25px;
    }
</style>
{% endblock %}

{% block title %}URL Monitoring{% endblock %}

{% block content %}
<div class="page-body">
    <div class="container-fluid">
        <div class="page-title">
            <div class="row">
                <div class="col-6">
                    <h3>{{ breadcrumb.child }}</h3>
                </div>
                <div class="col-6 text-right">
                    <form method="get" action="" class="d-inline" id="export-form">
                        <input type="hidden" name="export" value="csv">
                        <input type="hidden" name="start_date" value="{{ filter_params.start_date|default:'' }}" id="export-start-date">
                        <input type="hidden" name="end_date" value="{{ filter_params.end_date|default:'' }}" id="export-end-date">
                        <input type="hidden" name="user_response" value="{{ filter_params.user_response|default:'' }}" id="export-user-response">
                        <input type="hidden" name="domain" value="{{ filter_params.domain|default:'' }}" id="export-domain">
                        <input type="hidden" name="min_rating" value="{{ filter_params.min_rating|default:'0' }}" id="export-min-rating">
                        <input type="hidden" name="max_rating" value="{{ filter_params.max_rating|default:'10' }}" id="export-max-rating">
                        
                        <!-- SSL Status array fields - will be dynamically updated -->
                        <div id="export-ssl-status-container">
                            {% for status in filter_params.ssl_status %}
                                <input type="hidden" name="ssl_status" value="{{ status }}">
                            {% endfor %}
                        </div>
                        
                        <!-- Domain Reputation array fields - will be dynamically updated -->
                        <div id="export-domain-reputation-container">
                            {% for reputation in filter_params.domain_reputation %}
                                <input type="hidden" name="domain_reputation" value="{{ reputation }}">
                            {% endfor %}
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i data-feather="download"></i> Export CSV
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="row">
            <div class="col-sm-12">
                <div class="card filter-section">
                    <div class="card-body">
                        <form method="get" id="filter-form">
                            <div class="row filter-row">
                                <!-- Date Filters -->
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="start_date">Start Date</label>
                                        <input type="text" class="form-control datepicker" id="start_date" name="start_date" value="{{ filter_params.start_date|default:'' }}" placeholder="Select Start Date">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="end_date">End Date</label>
                                        <input type="text" class="form-control datepicker" id="end_date" name="end_date" value="{{ filter_params.end_date|default:'' }}" placeholder="Select End Date">
                                    </div>
                                </div>

                                <!-- User Response -->
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="user_response">User Response</label>
                                        <select class="form-control" id="user_response" name="user_response">
                                            <option value="">All Responses</option>
                                            <option value="1" {% if filter_params.user_response == '1' %}selected{% endif %}>Safe</option>
                                            <option value="0" {% if filter_params.user_response == '0' %}selected{% endif %}>Unsafe</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Domain -->
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="domain">Domain</label>
                                        <input type="text" class="form-control" id="domain" name="domain" placeholder="Search domain..." value="{{ filter_params.domain|default:'' }}">
                                    </div>
                                </div>
                            </div>

                            <div class="row filter-row">
                                <!-- SSL Status -->
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="ssl_status">SSL Status</label>
                                        <select class="form-control multi-select" id="ssl_status" name="ssl_status" multiple="multiple">
                                            <option value="Secure" {% if 'Secure' in filter_params.ssl_status_list %}selected{% endif %}>Secure</option>
                                            <option value="Unsecured" {% if 'Unsecured' in filter_params.ssl_status_list %}selected{% endif %}>Unsecured</option>
                                            <option value="Moderate" {% if 'Moderate' in filter_params.ssl_status_list %}selected{% endif %}>Expiring Soon</option>
                                            <option value="Unknown" {% if 'Unknown' in filter_params.ssl_status_list %}selected{% endif %}>Unknown</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Domain Reputation -->
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="domain_reputation">Domain Reputation</label>
                                        <select class="form-control multi-select" id="domain_reputation" name="domain_reputation" multiple="multiple">
                                            <option value="Safe" {% if 'Safe' in filter_params.domain_reputation_list %}selected{% endif %}>Safe</option>
                                            <option value="Unsafe" {% if 'Unsafe' in filter_params.domain_reputation_list %}selected{% endif %}>Unsafe</option>
                                            <option value="Moderate" {% if 'Moderate' in filter_params.domain_reputation_list %}selected{% endif %}>Moderate</option>
                                            <option value="Unknown" {% if 'Unknown' in filter_params.domain_reputation_list %}selected{% endif %}>Unknown</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Rating Range -->
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Rating Range</label>
                                        <div id="rating-slider"></div>
                                        <div class="d-flex justify-content-between mt-2">
                                            <span>Min: <strong id="min-rating-value">{{ filter_params.min_rating|default:'0' }}</strong></span>
                                            <span>Max: <strong id="max-rating-value">{{ filter_params.max_rating|default:'10' }}</strong></span>
                                        </div>
                                        <input type="hidden" id="min-rating" name="min_rating" value="{{ filter_params.min_rating|default:'0' }}">
                                        <input type="hidden" id="max-rating" name="max_rating" value="{{ filter_params.max_rating|default:'10' }}">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12">
                                    <button type="submit" class="btn btn-primary filter-btn">Apply Filters</button>
                                    <a href="?" class="btn btn-secondary filter-btn">Reset</a>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- URL Monitoring Table -->
        <div class="row">
            <div class="col-sm-12">
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="display" id="url-monitoring-table">
                                <thead>
                                    <tr>
                                        <th data-data="id">ID</th>
                                        <th data-data="domain">Domain</th>
                                        <th data-data="ssl_status">SSL Status</th>
                                        <th data-data="domain_reputation">Reputation</th>
                                        <th data-data="rating">Rating</th>
                                        <th data-data="user_response">User Response</th>
                                        <th data-data="created_at">Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script src="{% static 'assets/js/datatable/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'assets/js/datatable/datatables/datatable.custom.js' %}"></script>
<script src="{% static 'assets/js/tooltip-init.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.5.0/nouislider.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the datepickers
    flatpickr(".datepicker", {
        dateFormat: "Y-m-d",
    });

    // Initialize Select2 for multiple selects
    $('.multi-select').select2({
        placeholder: "Select options",
        allowClear: true,
        templateSelection: function(data, container) {
            $(container).attr('title', data.text);
            return data.text;
        }
    });

    // Initialize noUiSlider for rating range
    var ratingSlider = document.getElementById('rating-slider');
    noUiSlider.create(ratingSlider, {
        start: [parseInt("{{ filter_params.min_rating|default:'0' }}"), parseInt("{{ filter_params.max_rating|default:'10' }}")],
        connect: true,
        range: {
            'min': 0,
            'max': 10
        },
        step: 1,
        tooltips: [true, true],
        format: {
            to: function(value) {
                return Math.round(value);
            },
            from: function(value) {
                return Math.round(value);
            }
        }
    });

    // Update display values when slider changes
    ratingSlider.noUiSlider.on('update', function(values, handle) {
        var minValue = Math.round(values[0]);
        var maxValue = Math.round(values[1]);
        document.getElementById('min-rating-value').textContent = minValue;
        document.getElementById('max-rating-value').textContent = maxValue;
        document.getElementById('min-rating').value = minValue;
        document.getElementById('max-rating').value = maxValue;
    });

    // Initialize DataTable with server-side processing
    var table = $('#url-monitoring-table').DataTable({
        "processing": true,
        "serverSide": true,
        "ajax": {
            "url": window.location.href,
            "type": "GET",
            "data": function(d) {
                // Add filter parameters to the DataTables request
                d.start_date = $('#start_date').val();
                d.end_date = $('#end_date').val();
                d.user_response = $('#user_response').val();
                d.domain = $('#domain').val();
                d.ssl_status = $('#ssl_status').val();
                d.domain_reputation = $('#domain_reputation').val();
                d.min_rating = $('#min-rating').val();
                d.max_rating = $('#max-rating').val();
            }
        },
        "columns": [
            {"data": "id"},
            {"data": "domain"},
            {
                "data": "ssl_status",
                "render": function(data, type, row) {
                    if (data === 'Secure') {
                        return '<span class="badge badge-success">Secure</span>';
                    } else if (data === 'Unsecured') {
                        return '<span class="badge badge-danger">Unsecured</span>';
                    } else if (data === 'Moderate') {
                        return '<span class="badge badge-warning">Expiring Soon</span>';
                    } else {
                        return '<span class="badge badge-secondary">Unknown</span>';
                    }
                }
            },
            {
                "data": "domain_reputation",
                "render": function(data, type, row) {
                    if (data && data.includes('Safe')) {
                        return '<span class="badge badge-success">Safe</span>';
                    } else if (data && data.includes('Unsafe')) {
                        return '<span class="badge badge-danger">Unsafe</span>';
                    } else if (data && data.includes('Moderate')) {
                        return '<span class="badge badge-warning">Moderate</span>';
                    } else {
                        return '<span class="badge badge-secondary">Unknown</span>';
                    }
                }
            },
            {
                "data": "rating",
                "render": function(data, type, row) {
                    const rating = parseFloat(data) || 0;
                    const width = rating * 10;
                    let progressClass = 'bg-danger';
                    if (rating >= 7) progressClass = 'bg-success';
                    else if (rating >= 4) progressClass = 'bg-warning';
                    
                    return `
                        <div class="progress" style="height: 8px; width: 100px;">
                            <div class="progress-bar ${progressClass}" role="progressbar" 
                                style="width: ${width}%" 
                                aria-valuenow="${rating}" 
                                aria-valuemin="0" 
                                aria-valuemax="10">
                            </div>
                        </div>
                        <small>${rating}/10</small>
                    `;
                }
            },
            {
                "data": "user_response",
                "render": function(data, type, row) {
                    if (data === 0) {
                        return '<span class="badge badge-danger">Unsafe</span>';
                    } else if (data === 1) {
                        return '<span class="badge badge-success">Safe</span>';
                    } else {
                        return '<span class="badge badge-secondary">No Response</span>';
                    }
                }
            },
            {"data": "created_at"}
        ],
        "responsive": true,
        "lengthMenu": [10, 25, 50, 100],
        "pageLength": 10
    });

    // Function to update export form with current filter values
    function updateExportForm() {
        // Update simple fields
        document.getElementById('export-start-date').value = document.getElementById('start_date').value || '';
        document.getElementById('export-end-date').value = document.getElementById('end_date').value || '';
        document.getElementById('export-user-response').value = document.getElementById('user_response').value || '';
        document.getElementById('export-domain').value = document.getElementById('domain').value || '';
        document.getElementById('export-min-rating').value = document.getElementById('min-rating').value || '0';
        document.getElementById('export-max-rating').value = document.getElementById('max-rating').value || '10';
        
        // Update SSL Status array
        const sslStatusContainer = document.getElementById('export-ssl-status-container');
        sslStatusContainer.innerHTML = '';
        const sslStatusValues = $('#ssl_status').val() || [];
        sslStatusValues.forEach(function(value) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'ssl_status';
            input.value = value;
            sslStatusContainer.appendChild(input);
        });
        
        // Update Domain Reputation array
        const domainReputationContainer = document.getElementById('export-domain-reputation-container');
        domainReputationContainer.innerHTML = '';
        const domainReputationValues = $('#domain_reputation').val() || [];
        domainReputationValues.forEach(function(value) {
            const input = document.createElement('input');
            input.name = 'domain_reputation';
            input.type = 'hidden';
            input.value = value;
            domainReputationContainer.appendChild(input);
        });
    }

    // Update export form when filters change
    // Update export form when filters change
    $('#filter-form').on('submit', function(e) {
        e.preventDefault();
        
        // Update export form fields
        updateExportForm();
        
        // Reload DataTable with new filters
        table.ajax.reload();
    });

    // Also update export form when any filter input changes
    $('#start_date, #end_date, #user_response, #domain').on('change', updateExportForm);
    $('#ssl_status, #domain_reputation').on('change', updateExportForm);
    
    // Update export form when slider changes
    ratingSlider.noUiSlider.on('set', updateExportForm);

    // Initialize export form with current values
    updateExportForm();

    // Initialize feather icons
    if (feather) {
        feather.replace();
    }
});
</script>
{% endblock %}