{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}
{% load sass_tags %}

{% block css %}
<!-- Plugins css start-->
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/datatables.scss' %}">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.5.0/nouislider.min.css">
<style>
    @media (max-width: 576px) {
        .action-card {
            width: 120px;
        }
    }
    .filter-section {
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 5px;
        background-color: #f8f9fa;
    }
    .filter-row {
        margin-bottom: 15px;
    }
    .filter-btn {
        margin-right: 10px;
    }
    .select2-container {
        width: 100% !important;
    }
    
    /* Fixed styling for Select2 multiple selections */
    .select2-container .select2-selection--multiple .select2-selection__choice {
        padding-right: 20px !important;
        position: relative;
        margin-top: 4px;
        margin-right: 5px;
        overflow: hidden;
    }

    .select2-container .select2-selection--multiple .select2-selection__choice__remove {
        position: absolute;
        right: 3px;
        top: 0;
        font-weight: bold;
    }

    /* Ensure the selection container has enough height */
    .select2-container .select2-selection--multiple {
        min-height: 38px;
    }

    /* Make the text truncate properly when too long */
    .select2-container .select2-selection--multiple .select2-selection__choice__display {
        max-width: 95%;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
        color: #fff !important;
        float: inline-end !important;
    }
    .select2-container .select2-selection--multiple .select2-selection__choice__remove {
        position: relative !important;
        right: 3px;
        top: 0;
        font-weight: bold;
    }
    
    /* Status badges */
    .badge-active {
        background-color: #28a745;
    }
    .badge-expired {
        background-color: #6c757d;
    }
    .badge-cancelled {
        background-color: #dc3545;
    }
    .badge-pending {
        background-color: #ffc107;
        color: #212529;
    }
    .badge-renewed {
        background-color: #17a2b8;
    }
    .badge-upgraded {
        background-color: #6610f2;
    }
</style>
{% endblock %}

{% block title %}Subscription Report{% endblock %}

{% block content %}
<div class="page-body">
    <div class="container-fluid">
        <div class="page-title">
            <div class="row">
                <div class="col-6">
                    <h3>{{ breadcrumb.child }}</h3>
                </div>
                <div class="col-6 text-right">
                    <form method="get" action="" class="d-inline" id="export-form">
                        <input type="hidden" name="export" value="csv">
                        <input type="hidden" name="start_date" id="export-start-date" value="{{ filter_params.start_date|default:'' }}">
                        <input type="hidden" name="end_date" id="export-end-date" value="{{ filter_params.end_date|default:'' }}">
                        <input type="hidden" name="user_id" id="export-user-id" value="{{ filter_params.user_id|join:','|default:'' }}">
                        <input type="hidden" name="subscription_id" id="export-subscription-id" value="{{ filter_params.subscription_id|join:','|default:'' }}">
                        <input type="hidden" name="status" id="export-status" value="{{ filter_params.status|join:','|default:'' }}">
                        <input type="hidden" name="payment_method" id="export-payment-method" value="{{ filter_params.payment_method|join:','|default:'' }}">
                        <button type="submit" class="btn btn-primary">
                            <i data-feather="download"></i> Export CSV
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="row">
            <div class="col-sm-12">
                <div class="card filter-section">
                    <div class="card-body">
                        <form method="get" id="filter-form">
                            <div class="row filter-row">
                                <!-- Date Filters -->
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="start_date">Start Date</label>
                                        <input type="text" class="form-control datepicker" id="start_date" name="start_date" value="{{ filter_params.start_date|default:'' }}" placeholder="Select Start Date">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="end_date">End Date</label>
                                        <input type="text" class="form-control datepicker" id="end_date" name="end_date" value="{{ filter_params.end_date|default:'' }}" placeholder="Select End Date">
                                    </div>
                                </div>

                                <!-- User Filter -->
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="user_id">User</label>
                                        <select class="form-control multi-select" id="user_id" name="user_id" multiple="multiple">
                                            {% for user in users %}
                                                <option value="{{ user.id }}" {% if user.id|stringformat:"s" in filter_params.user_id %}selected{% endif %}>{{ user.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>

                                <!-- Subscription Filter -->
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="subscription_id">Subscription</label>
                                        <select class="form-control multi-select" id="subscription_id" name="subscription_id" multiple="multiple">
                                            {% for subscription in all_subscriptions %}
                                                <option value="{{ subscription.id }}" {% if subscription.id|stringformat:"s" in filter_params.subscription_id %}selected{% endif %}>{{ subscription.name_en }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="row filter-row">
                                <!-- Status Filter -->
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="status">Status</label>
                                        <select class="form-control multi-select" id="status" name="status" multiple="multiple">
                                            {% for status in statuses %}
                                                <option value="{{ status.0 }}" {% if status.0|stringformat:"s" in filter_params.status %}selected{% endif %}>{{ status.1 }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>

                                <!-- Payment Method Filter -->
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="payment_method">Payment Method</label>
                                        <select class="form-control multi-select" id="payment_method" name="payment_method" multiple="multiple">
                                            {% for method in payment_methods %}
                                                <option value="{{ method }}" {% if method in filter_params.payment_method %}selected{% endif %}>{{ method }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12">
                                    <button type="submit" class="btn btn-primary filter-btn">Apply Filters</button>
                                    <a href="?" class="btn btn-secondary filter-btn">Reset</a>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subscription Table -->
        <div class="row">
            <div class="col-sm-12">
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="display" id="subscription-report-table">
                                <thead>
                                    <tr>
                                        <th data-data="id">ID</th>
                                        <th data-data="user_name">User</th>
                                        <th data-data="subscription_name">Subscription</th>
                                        <th data-data="start_date">Start Date</th>
                                        <th data-data="end_date">End Date</th>
                                        <th data-data="status_display">Status</th>
                                        <th data-data="payment_method">Payment Method</th>
                                        <th data-data="transaction_id">Transaction ID</th>
                                        <th data-data="amount_paid">Amount Paid</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script src="{% static 'assets/js/datatable/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'assets/js/datatable/datatables/datatable.custom.js' %}"></script>
<script src="{% static 'assets/js/tooltip-init.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the datepickers
    flatpickr(".datepicker", {
        dateFormat: "Y-m-d",
    });

    // Initialize Select2 for multiple selects
    $('.multi-select').select2({
        placeholder: "Select options",
        allowClear: true,
        templateSelection: function(data, container) {
            $(container).attr('title', data.text);
            return data.text;
        }
    });

    // Function to update export form with current filter values
    function updateExportForm() {
        $('#export-start-date').val($('#start_date').val() || '');
        $('#export-end-date').val($('#end_date').val() || '');
        
        // Handle multi-select values - join with comma
        const userIds = $('#user_id').val();
        $('#export-user-id').val(userIds && userIds.length > 0 ? userIds.join(',') : '');
        
        const subscriptionIds = $('#subscription_id').val();
        $('#export-subscription-id').val(subscriptionIds && subscriptionIds.length > 0 ? subscriptionIds.join(',') : '');
        
        const statuses = $('#status').val();
        $('#export-status').val(statuses && statuses.length > 0 ? statuses.join(',') : '');
        
        const paymentMethods = $('#payment_method').val();
        $('#export-payment-method').val(paymentMethods && paymentMethods.length > 0 ? paymentMethods.join(',') : '');
    }

    // Initialize DataTable with server-side processing
    var table = $('#subscription-report-table').DataTable({
        "processing": true,
        "serverSide": true,
        "ajax": {
            "url": window.location.href,
            "type": "GET",
            "data": function(d) {
                // Add filter parameters to the DataTables request
                d.start_date = $('#start_date').val();
                d.end_date = $('#end_date').val();
                d.user_id = $('#user_id').val();
                d.subscription_id = $('#subscription_id').val();
                d.status = $('#status').val();
                d.payment_method = $('#payment_method').val();
            }
        },
        "columns": [
            {"data": "id"},
            {"data": "user_name"},
            {"data": "subscription_name"},
            {"data": "start_date"},
            {"data": "end_date"},
            {
                "data": "status_display",
                "render": function(data, type, row) {
                    let badgeClass = 'badge-secondary';
                    if (row.status == 1) badgeClass = 'badge-active';
                    else if (row.status == 2) badgeClass = 'badge-expired';
                    else if (row.status == 3) badgeClass = 'badge-cancelled';
                    else if (row.status == 4) badgeClass = 'badge-pending';
                    else if (row.status == 5) badgeClass = 'badge-renewed';
                    else if (row.status == 6) badgeClass = 'badge-upgraded';
                    
                    return `<span class="badge ${badgeClass}">${data}</span>`;
                }
            },
            {"data": "payment_method"},
            {"data": "transaction_id"},
            {"data": "amount_paid"}
        ],
        "responsive": true,
        "lengthMenu": [10, 25, 50, 100],
        "pageLength": 10
    });

    // Update export form when filters change
    $('#filter-form').on('submit', function(e) {
        e.preventDefault();
        
        // Update export form fields with current filter values
        updateExportForm();
        
        // Reload DataTable with new filters
        table.ajax.reload();
    });

    // Update export form when any filter changes (real-time)
    $('#start_date, #end_date').on('change', updateExportForm);
    $('#user_id, #subscription_id, #status, #payment_method').on('change', updateExportForm);

    // Initialize export form with current values on page load
    updateExportForm();

    // Reset filters
    $('a[href="?"]').on('click', function(e) {
        e.preventDefault();
        window.location.href = window.location.pathname;
    });

    // Initialize feather icons after DataTable is drawn
    table.on('draw', function() {
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
    });
});
</script>
{% endblock %}
