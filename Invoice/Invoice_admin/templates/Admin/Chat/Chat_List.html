{% extends 'base.html' %}
{% load static %}
{% load sass_tags %}

{% block css %}
<!-- Plugins css start-->
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/datatables.scss' %}">
<!-- Plugins css Ends-->
<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: 70vh;
        max-height: 800px;
        border: 1px solid #e9ecef;
        border-radius: 0.25rem;
        overflow: hidden;
    }

    .chat-wrapper {
        display: flex;
        flex: 1;
        overflow: hidden;
        position: relative;
    }

    .chat-list-container {
        width: 350px;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #e9ecef;
        background-color: #fff;
    }

    .chat-list {
        flex: 1;
        overflow-y: auto;
    }

    .chat-content-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #e5ddd5 url('{% static "assets/images/chat-bg.png" %}');
        background-blend-mode: overlay;
    }

    .chat-header {
        background: #f0f2f5;
        padding: 10px 15px;
        border-bottom: 1px solid #e9ecef;
    }

    .chat-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        min-height: 300px;
    }

    .chat-input {
        background: #f0f2f5;
        padding: 10px 15px;
        border-top: 1px solid #e9ecef;
    }

    .chat-item {
        padding: 10px 15px;
        border-bottom: 1px solid #e9ecef;
        cursor: pointer;
        transition: background 0.2s;
    }

    .chat-item:hover, .chat-item.active {
        background: #f0f2f5;
    }

    .chat-item.unread {
        background: #e8f4ff;
    }

    .chat-time {
        font-size: 12px;
        color: #667781;
    }

    .unread-count {
        background-color: #3a7afe;
        color: white;
        border-radius: 50%;
        min-width: 20px;
        height: 20px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        padding: 0 5px;
    }

    .last-message {
        color: #667781;
        font-size: 13px;
    }

    .no-chat-selected {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        text-align: center;
        padding: 20px;
        color: #667781;
    }

    .empty-chat-list {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        text-align: center;
        padding: 20px;
        color: #667781;
    }

    .toggle-chat-list {
        display: none;
    }

    /* Mobile styles */
    @media (max-width: 767px) {
        .chat-container {
            height: calc(100vh - 120px) !important;
            min-height: unset !important;
            position: relative;
            overflow: hidden;
        }
        
        .chat-wrapper {
            min-height: unset;
            height: 100%;
            position: relative;
        }
        
        /* Mobile List View */
        .chat-list-container {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 10;
            transform: translateX(0);
            transition: transform 0.3s ease;
        }
        
        /* Mobile Chat Detail View */
        .chat-content-container {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 10;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex !important;
            background-color: #e5ddd5;
        }
        
        /* When chat detail is active */
        .chat-content-container.active {
            transform: translateX(0);
        }
        
        /* When chat list should be hidden */
        .chat-list-container.hidden {
            transform: translateX(-100%);
        }
        
        /* Back button */
        .toggle-chat-list {
            display: block !important;
        }
        
        /* Message input positioning */
        .chat-input {
            padding: 10px;
            background: white;
            border-top: 1px solid #e9ecef;
        }
        
        /* Enhance touch targets */
        .chat-item {
            padding: 12px 15px;
        }
        
        /* Adjust message container */
        .chat-messages {
            padding-bottom: 70px;
        }
        
        /* Message sizing for mobile */
        .message {
            max-width: 85%;
        }
        
        /* Input enhancements */
        #message-input {
            height: 45px;
            font-size: 16px;
            padding: 10px 15px;
        }
        
        .chat-input .btn {
            height: 45px;
            width: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    }

    @media (min-width: 768px) {
        .chat-container {
            height: 70vh;
            max-height: 800px;
        }
    }
</style>
{% endblock %}

{% block title %}Chat Management{% endblock %}

{% block content %}
<div class="page-body">
    <div class="container-fluid">
        <div class="page-title">
            <div class="row">
                <div class="col-12 col-sm-6">
                    <h3>{{breadcrumb.child}}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Container-fluid starts-->
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card chat-container">
                    <div class="chat-wrapper">
                        <!-- Chat List -->
                        <div class="chat-list-container">
                            <div class="card-header">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="icon-search"></i>
                                    </span>
                                    <input class="form-control" type="text" placeholder="Search or start new chat" id="chat-search">
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="chat-list">
                                    {% if chats %}
                                        {% for chat in chats %}
                                        <div class="chat-item {% if chat.unread_admin_count > 0 %}unread{% endif %}" 
                                             data-chat-id="{{ chat.id }}" 
                                             data-user-id="{{ chat.user.id }}">
                                            <div class="d-flex align-items-center">
                                                <div class="flex-shrink-0 position-relative">
                                                    {% if chat.user.profile_picture %}
                                                    <img class="rounded-circle" src="{{ chat.user.profile_picture.url }}" width="50" height="50" alt="img">
                                                    {% else %}
                                                    <img class="rounded-circle" src="{% static 'assets/images/dashboard/profile.jpg' %}" width="50" height="50" alt="img">
                                                    {% endif %}
                                                    <span class="position-absolute bottom-0 end-0 bg-{% if chat.is_active %}success{% else %}danger{% endif %} border border-2 border-white rounded-circle" style="width: 12px; height: 12px;"></span>
                                                </div>
                                                <div class="flex-grow-1 ms-3 overflow-hidden">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <h6 class="mb-0 text-truncate">{{ chat.user.name }}</h6>
                                                        <small class="chat-time">
                                                            {% with last_message=chat.messages.last %}
                                                            {% if last_message %}
                                                            {{ last_message.timestamp|time }}
                                                            {% endif %}
                                                            {% endwith %}
                                                        </small>
                                                    </div>
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <p class="last-message mb-0 text-truncate">
                                                            {% with last_message=chat.messages.last %}
                                                            {% if last_message %}
                                                            {{ last_message.message|truncatechars:30 }}
                                                            {% else %}
                                                            No messages yet
                                                            {% endif %}
                                                            {% endwith %}
                                                        </p>
                                                        {% if chat.unread_admin_count > 0 %}
                                                        <span class="unread-count">{{ chat.unread_admin_count }}</span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="empty-chat-list">
                                            <div class="bg-light rounded-circle p-4 mb-3">
                                                <i class="icon-message-square text-muted" style="font-size: 2rem;"></i>
                                            </div>
                                            <h5 class="mb-2">No chats available</h5>
                                            <p class="text-muted">When you have active chats, they will appear here</p>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Chat Content -->
                        <div class="chat-content-container" id="chat-content">
                            {% if active_chat %}
                                {% include 'Admin/Chat/chat_content_partial.html' with chat=active_chat %}
                            {% else %}
                                <div class="no-chat-selected">
                                    <div class="bg-light rounded-circle p-4 mb-3">
                                        <i class="icon-message-square text-muted" style="font-size: 2rem;"></i>
                                    </div>
                                    <h5 class="mb-2">Select a chat to start messaging</h5>
                                    <p class="text-muted">Choose a conversation from the list to view messages</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Container-fluid Ends-->
</div>
{% endblock %}

{% block script %}
<script>
$(document).ready(function() {
    let currentChatId = null;
    let chatRefreshInterval = null;
    
    // Function to scroll to bottom of chat messages
    function scrollToBottom() {
        const messagesContainer = document.getElementById('chat-messages');
        if (messagesContainer) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }
    
    // Setup chat refresh interval
    function setupChatRefresh(chatId) {
        // Clear any existing interval
        if (chatRefreshInterval) {
            clearInterval(chatRefreshInterval);
        }
        
        // Set new interval
        chatRefreshInterval = setInterval(function() {
            refreshChatContent(chatId);
        }, 5000);
    }
    
    // Enhanced chat loading function
    function loadChat(chatId) {
        if (!chatId) return;
        currentChatId = chatId;

        $.ajax({
            url: `/chats/${chatId}/content/`,
            method: 'GET',
            headers: {
                "X-Requested-With": "XMLHttpRequest"
            },
            success: function(response) {
                $('#chat-content').html(response);
                setupChatRefresh(chatId);
                
                console.log("Chat content loaded successfully");
                
                // Ensure scroll to bottom after loading chat
                scrollToBottom();
                
                // Set active class on mobile for the chat content
                if (window.innerWidth < 768) {
                    showChatContent();
                }
            },
            error: function(xhr, status, error) {
                console.error("Error loading chat:", error);
                console.log("Response:", xhr.responseText);
                alert("Error loading chat. Please try again.");
            }
        });
    }
    
    // Improved refresh chat content function
    function refreshChatContent(chatId) {
        // Save the current scroll position and input value
        const messagesContainer = $('#chat-messages')[0];
        const wasScrolledToBottom = isScrolledToBottom('#chat-messages');
        const currentInputValue = $('#message-input').val();
        const scrollPosition = messagesContainer ? messagesContainer.scrollTop : 0;
        
        // Get the last message ID for comparison
        const lastMessageElement = $('#chat-messages .message').last();
        const lastMessageId = lastMessageElement.length ? lastMessageElement.data('message-id') || 0 : 0;
        
        $.ajax({
            url: `/chats/${chatId}/content/?last_id=${lastMessageId}`,
            method: 'GET',
            headers: {
                "X-Requested-With": "XMLHttpRequest"
            },
            success: function(response) {
                // Extract just the messages part
                const parser = new DOMParser();
                const doc = parser.parseFromString(response, 'text/html');
                const newMessages = doc.getElementById('chat-messages');
                
                if (newMessages) {
                    // Check if there are new messages by comparing content
                    const currentMessagesCount = $('#chat-messages .message').length;
                    const newMessagesCount = $(newMessages).find('.message').length;
                    
                    // Only update if there are new messages
                    if (newMessagesCount > currentMessagesCount) {
                        // Replace only the messages content
                        $('#chat-messages').replaceWith(newMessages);
                        
                        // Restore the input value
                        $('#message-input').val(currentInputValue);
                        
                        // Only scroll to bottom if user was already at the bottom
                        if (wasScrolledToBottom) {
                            scrollToBottom();
                        } else {
                            // Otherwise restore previous scroll position
                            const updatedContainer = $('#chat-messages')[0];
                            if (updatedContainer) {
                                updatedContainer.scrollTop = scrollPosition;
                            }
                        }
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error("Error refreshing chat:", error);
            }
        });
    }

    // Chat list refresh
    function refreshChatList() {
        $.ajax({
            url: "{% url 'admin_chat_list' %}",
            method: 'GET',
            headers: {
                "X-Requested-With": "XMLHttpRequest"
            },
            success: function(response) {
                $('.chat-list').html(response);
            },
            error: function(xhr, status, error) {
                console.error("Error refreshing chat list:", error);
            }
        });
    }

    // Send message function
    function sendMessage(chatId, message) {
        console.log('Attempting to send message:', message, 'to chat:', chatId);
        
        $.ajax({
            url: `/chats/${chatId}/send/`,
            method: 'POST',
            data: {
                message: message,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('Message sent successfully', response);
                $('#message-input').val('');
                refreshChatContent(chatId);
                
                // Focus back on input
                $('#message-input').focus();
            },
            error: function(xhr, status, error) {
                console.error('Error sending message:', error);
                console.log('Response:', xhr.responseText);
                alert('Error sending message. Please try again.');
            }
        });
    }

    // Utility functions
    function isScrolledToBottom(selector) {
        const element = $(selector)[0];
        if (!element) return true;
        return element.scrollHeight - element.scrollTop <= element.clientHeight + 10;
    }

    // Focus message input (especially helpful for mobile)
    function focusMessageInput() {
        // Short delay to ensure input is visible
        setTimeout(() => {
            const input = document.getElementById('message-input');
            if (input) input.focus();
        }, 300);
    }

    // Mobile view toggle functions
    function showChatList() {
        console.log("Showing chat list view");
        $('.chat-content-container').removeClass('active');
        $('.chat-list-container').removeClass('hidden');
    }

    function showChatContent() {
        console.log("Showing chat detail view");
        $('.chat-list-container').addClass('hidden');
        $('.chat-content-container').addClass('active');
        focusMessageInput();
    }

    // Event Listeners
    
    // Handle chat item click for both desktop and mobile
    $(document).on('click', '.chat-item', function(e) {
        e.preventDefault();
        
        const chatId = $(this).data('chat-id');
        console.log("Chat item clicked, id:", chatId);
        
        // Reset active states
        $('.chat-item').removeClass('active');
        $(this).addClass('active');

        // Load chat content
        loadChat(chatId);
    });

    // Back button to show chat list on mobile
    $(document).on('click', '.toggle-chat-list', function(e) {
        e.preventDefault();
        console.log("Back button clicked");
        showChatList();
    });

    // Message form submission
    $(document).on('submit', '#message-form', function(e) {
        e.preventDefault();
        const message = $('#message-input').val().trim();
        
        if (message && currentChatId) {
            sendMessage(currentChatId, message);
        }
    });

    // Handle window resize
    function handleResize() {
        if (window.innerWidth >= 768) {
            // Desktop view - reset any mobile-specific styles
            $('.chat-list-container').removeClass('hidden');
            $('.chat-content-container').css('transform', '');
            $('.chat-list-container').css('transform', '');
            
            if (currentChatId) {
                $('.chat-content-container').removeClass('d-none');
            }
        } else {
            // Mobile view
            if (currentChatId && $('.chat-content-container').hasClass('active')) {
                // If we have an active chat on mobile, keep that view
                showChatContent();
            } else {
                // Otherwise default to list view
                showChatList();
            }
        }
    }

    // Periodic chat list and content refresh
    setInterval(refreshChatList, 20000);

    // Initial setup
    $(window).on('load', function() {
        handleResize();
        scrollToBottom();
        
        // On initial page load, if desktop and we have chat items, select the first one
        if (window.innerWidth >= 768 && $('.chat-item').length > 0) {
            $('.chat-item:first').trigger('click');
        }
    });

    // Listen for window resize
    $(window).on('resize', handleResize);

    // Chat search functionality
    $('#chat-search').on('input', function() {
        const searchTerm = $(this).val().toLowerCase().trim();
        
        // If search is empty, show all chats
        if (!searchTerm) {
            $('.chat-item').show();
            $('.no-search-results').remove();
            return;
        }
        
        // Filter chat items based on search term
        $('.chat-item').each(function() {
            const userName = $(this).find('h6').text().toLowerCase();
            const lastMessage = $(this).find('.last-message').text().toLowerCase();
            
            // Show item if username or last message contains the search term
            if (userName.includes(searchTerm) || lastMessage.includes(searchTerm)) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
        
        // Show empty state if no results
        if ($('.chat-item:visible').length === 0) {
            if ($('.no-search-results').length === 0) {
                $('.chat-list').append(`
                    <div class="empty-chat-list no-search-results">
                        <div class="bg-light rounded-circle p-4 mb-3">
                            <i class="icon-search text-muted" style="font-size: 2rem;"></i>
                        </div>
                        <h5 class="mb-2">No results found</h5>
                        <p class="text-muted">Try a different search term</p>
                    </div>
                `);
            }
        } else {
            $('.no-search-results').remove();
        }
    });
    
    // Clear search when ESC key is pressed
    $('#chat-search').on('keydown', function(e) {
        if (e.key === 'Escape') {
            $(this).val('');
            $(this).trigger('input');
        }
    });
});
</script>
{% endblock %}
